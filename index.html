<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>IMS - Inventory Management System</title>
    
    <!-- PWA Manifest & Icons (Note: Manifest may not load in preview mode) -->
    <!-- <link rel="manifest" href="manifest.json"> -->
    <meta name="theme-color" content="#4f46e5">
    
    <!-- Default Favicon -->
    <link rel="icon" type="image/png" href="./icon-512.png">
    
    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons (Vanilla JS version) -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- html2pdf.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <!-- Firebase SDKs (Compat version for easiest integration in single file) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        /* --- Mobile & Interaction Tweaks --- */
        
        /* Disable text selection and tap highlighting globally */
        * {
            -webkit-tap-highlight-color: transparent; /* Removes blue highlight on mobile tap */
            -webkit-touch-callout: none; /* Disables callout menu (copy/paste) on long press iOS */
            user-select: none; /* Standard disable selection */
            -webkit-user-select: none; /* Safari/Chrome disable selection */
        }

        /* Re-enable selection for inputs so users can type/edit text */
        input, textarea, select {
            user-select: text !important;
            -webkit-user-select: text !important;
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #c7c7c7; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }
        
        /* Print Styling */
        @media print {
            @page { margin: 10mm; size: A4; }
            body * { visibility: hidden; }
            .print-preview, .print-preview * { visibility: visible; }
            .print-preview { position: absolute; left: 0; top: 0; width: 100%; border: none; shadow: none; }
            .print-hidden { display: none !important; }
            .break-inside-avoid { page-break-inside: avoid !important; }
            tr { page-break-inside: avoid !important; }
        }

        /* Animations */
        .animate-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-white text-gray-900 antialiased overscroll-none">
    <div id="root"></div>

    <!-- Service Worker Registration (Disabled for Preview) -->
    <script>
        // if ('serviceWorker' in navigator) {
        //     window.addEventListener('load', () => {
        //         navigator.serviceWorker.register('./service-worker.js')
        //             .then(registration => {
        //                 console.log('ServiceWorker registration successful with scope: ', registration.scope);
        //             })
        //             .catch(err => {
        //                 console.log('ServiceWorker registration failed: ', err);
        //             });
        //     });
        // }
    </script>

    <script type="text/babel">
        // --- Firebase Initialization ---
        const firebaseConfig = {
            apiKey: "AIzaSyAOB5sXGQPdchw3jhWojfy749cOTeAcfyw",
            authDomain: "inventory-app-84fbf.firebaseapp.com",
            projectId: "inventory-app-84fbf",
            storageBucket: "inventory-app-84fbf.firebasestorage.app",
            messagingSenderId: "120713547404",
            appId: "1:120713547404:web:75d74b86820d33ee51b5a9",
            measurementId: "G-NSNP0QVKC6"
        };

        // Initialize Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.firestore();
        
        // Enable offline persistence
        db.enablePersistence()
            .catch((err) => {
                if (err.code == 'failed-precondition') {
                    console.warn('Persistence failed: Multiple tabs open');
                } else if (err.code == 'unimplemented') {
                    console.warn('Persistence not supported by browser');
                }
            });

        const { useState, useEffect, useMemo, useCallback, useRef } = React;

        // --- Icon Component Wrapper (Fixed for Lucide CDN) ---
        const Icon = ({ name, size = 24, className, ...props }) => {
            // Check if lucide is available
            if (typeof lucide === 'undefined' || !lucide.icons) {
                return null;
            }

            const iconData = lucide.icons[name];
            
            if (!iconData) {
                console.warn(`Icon "${name}" not found`);
                return null;
            }

            // Render SVG manually using the icon definition array
            return (
                <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width={size}
                    height={size}
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    strokeWidth="2"
                    strokeLinecap="round"
                    strokeLinejoin="round"
                    className={className}
                    {...props}
                >
                    {iconData.map(([tag, attrs], index) => (
                        React.createElement(tag, { ...attrs, key: index })
                    ))}
                </svg>
            );
        };

        // Icons mapping
        const LayoutDashboard = (p) => <Icon name="LayoutDashboard" {...p} />;
        const Package = (p) => <Icon name="Package" {...p} />;
        const Layers = (p) => <Icon name="Layers" {...p} />;
        const Box = (p) => <Icon name="Box" {...p} />;
        const History = (p) => <Icon name="History" {...p} />;
        const Settings = (p) => <Icon name="Settings" {...p} />;
        const LogOut = (p) => <Icon name="LogOut" {...p} />;
        const Search = (p) => <Icon name="Search" {...p} />;
        const Plus = (p) => <Icon name="Plus" {...p} />;
        const Trash2 = (p) => <Icon name="Trash2" {...p} />;
        const Edit = (p) => <Icon name="Edit" {...p} />;
        const ChevronDown = (p) => <Icon name="ChevronDown" {...p} />;
        const ChevronRight = (p) => <Icon name="ChevronRight" {...p} />;
        const Menu = (p) => <Icon name="Menu" {...p} />;
        const X = (p) => <Icon name="X" {...p} />;
        const User = (p) => <Icon name="User" {...p} />;
        const Shield = (p) => <Icon name="Shield" {...p} />;
        const ArrowUpDown = (p) => <Icon name="ArrowUpDown" {...p} />;
        const Printer = (p) => <Icon name="Printer" {...p} />;
        const CheckCircle = (p) => <Icon name="CheckCircle" {...p} />;
        const AlertTriangle = (p) => <Icon name="AlertTriangle" {...p} />;
        const ArrowRightLeft = (p) => <Icon name="ArrowRightLeft" {...p} />;
        const Eye = (p) => <Icon name="Eye" {...p} />;
        const EyeOff = (p) => <Icon name="EyeOff" {...p} />;
        const CheckSquare = (p) => <Icon name="CheckSquare" {...p} />;
        const Square = (p) => <Icon name="Square" {...p} />;
        const AlertOctagon = (p) => <Icon name="AlertOctagon" {...p} />;
        const Truck = (p) => <Icon name="Truck" {...p} />;
        const Download = (p) => <Icon name="Download" {...p} />;
        const FileText = (p) => <Icon name="FileText" {...p} />;
        const Save = (p) => <Icon name="Save" {...p} />;
        const XCircle = (p) => <Icon name="XCircle" {...p} />;
        const Archive = (p) => <Icon name="Archive" {...p} />;
        const Activity = (p) => <Icon name="Activity" {...p} />;
        const Users = (p) => <Icon name="Users" {...p} />;
        const Key = (p) => <Icon name="Key" {...p} />;
        const Filter = (p) => <Icon name="Filter" {...p} />;
        const LayoutGrid = (p) => <Icon name="LayoutGrid" {...p} />;
        const Info = (p) => <Icon name="Info" {...p} />;

        // --- Constants & Helpers ---

        const ROLES = {
            SUPERVISOR: 'Technical Support Supervisor',
            LEAD: 'Live Operator Lead',
            TRAINER: 'Live Operator Trainer',
            OPERATOR: 'Live Operator'
        };

        const ADMIN_ROLES = [ROLES.SUPERVISOR, ROLES.LEAD, ROLES.TRAINER];

        const DEFAULT_USERS = [
            { id: 'u1', username: 'admin', password: '123', role: ROLES.SUPERVISOR, name: 'System Admin' },
        ];

        const INITIAL_DATA = {
            users: DEFAULT_USERS,
            categories: [], 
            floors: [],     
            boxes: [],      
            items: [],      
            logs: [
                { id: 1, timestamp: new Date().toISOString(), user: 'System', action: 'System Reset', details: 'Application data cleared for fresh start' }
            ]
        };

        const generateId = (itemName, existingItems) => {
            const words = itemName.split(' ');
            let prefix = '';
            if (words.length >= 2) {
                prefix = (words[0][0] + words[1][0]).toUpperCase();
            } else {
                prefix = itemName.substring(0, 2).toUpperCase();
            }
            
            const samePrefixItems = existingItems.filter(i => i.id.startsWith(prefix + '-'));
            let maxNum = 0;
            
            samePrefixItems.forEach(item => {
                const numPart = parseInt(item.id.split('-')[1]);
                if (!isNaN(numPart) && numPart > maxNum) maxNum = numPart;
            });

            const nextNum = (maxNum + 1).toString().padStart(4, '0');
            return `${prefix}-${nextNum}`;
        };

        const generateNextId = (items, prefix) => {
            if (!items || items.length === 0) return `${prefix}1`;
            const ids = items.map(i => {
                const numStr = i.id.replace(prefix, '');
                const num = parseInt(numStr);
                return isNaN(num) ? 0 : num;
            });
            const maxId = Math.max(0, ...ids);
            return `${prefix}${maxId + 1}`;
        };

        const generateRoomId = (floorCode, existingRooms) => {
            const prefix = `${floorCode}-R`;
            const ids = existingRooms.map(r => {
                if (!r.id.startsWith(prefix)) return 0;
                const numStr = r.id.replace(prefix, '');
                const num = parseInt(numStr);
                return isNaN(num) ? 0 : num;
            });
            const maxId = Math.max(0, ...ids);
            const nextNum = (maxId + 1).toString().padStart(2, '0');
            return `${prefix}${nextNum}`;
        };

        // --- Common Components ---

        const Card = ({ children, className = "" }) => (
            <div className={`bg-white rounded-lg shadow-sm border border-gray-200 ${className}`}>
                {children}
            </div>
        );

        const Badge = ({ children, color = "blue" }) => {
            const colors = {
                blue: "bg-blue-100 text-blue-800",
                green: "bg-green-100 text-green-800",
                purple: "bg-purple-100 text-purple-800",
                orange: "bg-orange-100 text-orange-800",
                gray: "bg-gray-100 text-gray-800",
                red: "bg-red-100 text-red-800",
                yellow: "bg-yellow-100 text-yellow-800"
            };
            return <span className={`px-2 py-1 rounded-full text-xs font-medium ${colors[color] || colors.gray}`}>{children}</span>;
        };

        const Button = ({ children, onClick, variant = "primary", className = "", disabled = false, size = "md", title, style, type = "button" }) => {
            const variants = {
                primary: "bg-indigo-600 text-white hover:bg-indigo-700 disabled:bg-indigo-300",
                secondary: "bg-white text-gray-700 border border-gray-300 hover:bg-gray-50 disabled:bg-gray-100",
                danger: "bg-red-600 text-white hover:bg-red-700 disabled:bg-red-300",
                ghost: "bg-transparent text-gray-600 hover:bg-gray-100"
            };
            const sizes = {
                sm: "px-2 py-1 text-xs",
                md: "px-4 py-2 text-sm",
                lg: "px-6 py-3 text-base"
            };
            return (
                <button 
                    type={type}
                    onClick={onClick} 
                    disabled={disabled}
                    title={title}
                    style={style}
                    className={`rounded-md transition-colors duration-200 flex items-center justify-center gap-2 relative z-10 cursor-pointer ${variants[variant]} ${sizes[size]} ${className}`}
                >
                    {children}
                </button>
            );
        };

        const Input = ({ label, className="", ...props }) => (
            <div className={`mb-4 ${className}`}>
                {label && <label className="block text-xs font-bold text-gray-500 uppercase mb-1">{label}</label>}
                <input className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 text-sm" {...props} />
            </div>
        );

        const Select = ({ label, options, className="", ...props }) => (
            <div className={`mb-4 ${className}`}>
                {label && <label className="block text-xs font-bold text-gray-500 uppercase mb-1">{label}</label>}
                <select className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 text-sm" {...props}>
                    {options.map((opt, idx) => (
                        <option key={opt.value || idx} value={opt.value} disabled={opt.disabled}>{opt.label}</option>
                    ))}
                </select>
            </div>
        );

        // --- Custom Dialog ---
        const CustomDialog = ({ isOpen, type, message, defaultValue, onConfirm, onClose }) => {
            const [inputVal, setInputVal] = useState('');
            useEffect(() => { if (isOpen) setInputVal(defaultValue || ''); }, [isOpen, defaultValue]);
            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 bg-black/60 z-[100] flex items-center justify-center p-4">
                    <div className="bg-white rounded-lg shadow-xl max-w-sm w-full p-6 animate-in fade-in zoom-in duration-200">
                        <h3 className="text-lg font-bold mb-2 capitalize">{type === 'alert' ? 'Notice' : type === 'confirm' ? 'Confirm Action' : 'Input Required'}</h3>
                        <p className="text-gray-600 mb-4 whitespace-pre-wrap">{message}</p>
                        {type === 'prompt' && (
                            <input 
                                className="w-full border p-2 rounded mb-4 focus:ring-2 focus:ring-indigo-500 outline-none"
                                value={inputVal}
                                onChange={(e) => setInputVal(e.target.value)}
                                onKeyDown={(e) => e.key === 'Enter' && onConfirm(inputVal)}
                                autoFocus
                            />
                        )}
                        <div className="flex justify-end gap-2">
                            {type !== 'alert' && <button onClick={onClose} className="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded">Cancel</button>}
                            <button onClick={() => type === 'prompt' ? onConfirm(inputVal) : onConfirm()} className="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700">
                                {type === 'alert' ? 'OK' : 'Confirm'}
                            </button>
                        </div>
                    </div>
                </div>
            )
        };

        // --- Log Details Modal ---
        const LogDetailsModal = ({ log, onClose, allItems }) => {
            if (!log) return null;

            // Parser logic:
            // Format: "Summary: [id] Name, [id] Name"
            const separatorIndex = log.details.indexOf(': [');
            const hasDetails = separatorIndex !== -1;
            
            const title = hasDetails ? log.details.substring(0, separatorIndex) : 'Action Details';
            const content = hasDetails ? log.details.substring(separatorIndex + 2).trim() : log.details;
            
            // Split logic for item list
            const rawItems = hasDetails ? content.split(', ').filter(Boolean) : [content];

            // Parse items into objects for grouping
            // Expected format: "[ID-123] Item Name"
            const parsedItems = hasDetails ? rawItems.map(itemStr => {
                const match = itemStr.match(/^\[(.*?)\] (.*)$/);
                if (match) {
                    const id = match[1];
                    const name = match[2];
                    // Try to find category info from current data (best effort)
                    const foundItem = allItems ? allItems.find(i => i.id === id) : null;
                    return { 
                        id, 
                        name, 
                        category: foundItem ? foundItem.category : 'Unknown Category',
                        subCategory: foundItem ? foundItem.subCategory : 'General'
                    };
                }
                return { id: '?', name: itemStr, category: 'Others', subCategory: 'General' };
            }) : [];

            // Group by Category -> SubCategory
            const groupedItems = {};
            if (hasDetails) {
                parsedItems.forEach(item => {
                    if (!groupedItems[item.category]) groupedItems[item.category] = {};
                    if (!groupedItems[item.category][item.subCategory]) groupedItems[item.category][item.subCategory] = [];
                    groupedItems[item.category][item.subCategory].push(item);
                });
            }

            return (
                <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
                    <div className="bg-white rounded-xl shadow-2xl w-full max-w-lg p-0 animate-in fade-in zoom-in duration-200 flex flex-col max-h-[85vh] overflow-hidden">
                        <div className="bg-gray-50 px-6 py-4 border-b flex justify-between items-start">
                            <div>
                                <h3 className="text-lg font-bold text-gray-900">{log.action}</h3>
                                <p className="text-xs text-gray-500 mt-1">{new Date(log.timestamp).toLocaleString()}</p>
                            </div>
                            <button onClick={onClose} className="text-gray-400 hover:text-gray-600 p-1 bg-white rounded-full border border-gray-200 shadow-sm"><X size={18}/></button>
                        </div>
                        
                        <div className="flex-1 overflow-y-auto p-6">
                            <div className="mb-4">
                                <p className="text-sm font-semibold text-gray-700 bg-blue-50 p-3 rounded-lg border border-blue-100 text-blue-800">{title}</p>
                            </div>

                            {hasDetails ? (
                                <div className="space-y-4">
                                    {Object.keys(groupedItems).sort().map(cat => (
                                        <div key={cat} className="border rounded-lg overflow-hidden">
                                            <div className="bg-gray-100 px-3 py-1.5 text-xs font-bold text-gray-600 uppercase tracking-wider">{cat}</div>
                                            {Object.keys(groupedItems[cat]).sort().map(sub => (
                                                <div key={sub} className="border-t border-gray-100 first:border-0">
                                                    <div className="bg-gray-50 px-3 py-1 text-[10px] font-semibold text-gray-500 border-b border-gray-100 pl-5">{sub}</div>
                                                    <ul className="divide-y divide-gray-50">
                                                        {groupedItems[cat][sub].map((item, idx) => (
                                                            <li key={idx} className="text-sm p-2 pl-6 flex justify-between items-center hover:bg-white">
                                                                <span className="text-gray-800">{item.name}</span>
                                                                <span className="text-[10px] font-mono text-gray-400 bg-gray-100 px-1.5 py-0.5 rounded">{item.id}</span>
                                                            </li>
                                                        ))}
                                                    </ul>
                                                </div>
                                            ))}
                                        </div>
                                    ))}
                                </div>
                            ) : (
                                <div className="text-sm text-gray-600 bg-gray-50 p-4 rounded-lg border border-dashed border-gray-300">
                                    {content}
                                </div>
                            )}
                        </div>
                        
                        <div className="p-4 border-t bg-gray-50 flex justify-end">
                            <Button onClick={onClose}>Close</Button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- Sub-Components ---

        const RoomSwapModal = ({ sourceRoom, data, setData, logAction, onClose, dialogs }) => {
            const [targetRoomId, setTargetRoomId] = useState('');

            const handleSwap = () => {
                if (!targetRoomId) {
                    dialogs.showAlert("Please select a room to swap with.");
                    return;
                }
                const targetFloor = data.floors.find(f => f.rooms.some(r => r.id === targetRoomId));
                const targetRoom = targetFloor?.rooms.find(r => r.id === targetRoomId);
                if (!targetRoom) return;

                dialogs.showConfirm(`CONFIRM ROOM SWAP:\n\nThis will swap Name, Status, and ALL Equipment between:\n\n[ ${sourceRoom.name} ] <--> [ ${targetRoom.name} ]\n\nAre you sure?`, () => {
                    const newFloors = data.floors.map(f => ({
                        ...f,
                        rooms: f.rooms.map(r => {
                            if (r.id === sourceRoom.id) return { ...r, name: targetRoom.name, status: targetRoom.status };
                            else if (r.id === targetRoom.id) return { ...r, name: sourceRoom.name, status: sourceRoom.status };
                            return r;
                        })
                    }));

                    const newItems = data.items.map(item => {
                        if (item.locationId === sourceRoom.id) return { ...item, locationId: targetRoom.id, location: sourceRoom.name };
                        else if (item.locationId === targetRoom.id) return { ...item, locationId: sourceRoom.id, location: targetRoom.name };
                        return item;
                    });

                    setData(prev => ({ ...prev, floors: newFloors, items: newItems }));
                    logAction('Room Swap', `Swapped Room ${sourceRoom.name} with ${targetRoom.name}`);
                    onClose();
                });
            };

            return (
                <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
                    <div className="bg-white rounded-lg shadow-xl w-full max-w-md p-6">
                        <div className="flex justify-between items-center mb-4">
                            <h3 className="text-xl font-bold">Swap Room</h3>
                            <button onClick={onClose}><X size={20} className="text-gray-500 hover:text-gray-700"/></button>
                        </div>
                        <div className="bg-blue-50 p-4 rounded-lg mb-6 border border-blue-100">
                            <p className="text-sm text-blue-800 font-medium mb-2">Source Room:</p>
                            <div className="flex justify-between items-center bg-white p-2 rounded border border-blue-200">
                                <span className="font-bold text-gray-800">{sourceRoom.name}</span>
                                <Badge color="blue">{sourceRoom.status}</Badge>
                            </div>
                        </div>
                        <div className="flex justify-center -my-9 relative z-10">
                            <div className="bg-white p-2 rounded-full border border-gray-200 shadow-sm"><ArrowUpDown size={20} className="text-gray-400" /></div>
                        </div>
                        <div className="mt-6 mb-6">
                            <label className="block text-sm font-bold text-gray-700 mb-2">Select Target Room:</label>
                            <select className="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-indigo-500 outline-none" value={targetRoomId} onChange={(e) => setTargetRoomId(e.target.value)}>
                                <option value="">-- Select Room to Swap With --</option>
                                {data.floors.map(floor => {
                                    const floorRooms = floor.rooms
                                        .filter(r => r.id !== sourceRoom.id)
                                        .sort((a, b) => a.id.localeCompare(b.id, undefined, { numeric: true }));
                                    
                                    if (floorRooms.length === 0) return null;

                                    return (
                                        <optgroup key={floor.id} label={`${floor.name} (${floor.code})`}>
                                            {floorRooms.map(r => (
                                                <option key={r.id} value={r.id}>
                                                    [{r.id}] {r.name} ({r.status})
                                                </option>
                                            ))}
                                        </optgroup>
                                    );
                                })}
                            </select>
                        </div>
                        <div className="flex justify-end gap-2">
                            <Button variant="secondary" onClick={onClose}>Cancel</Button>
                            <Button onClick={handleSwap} disabled={!targetRoomId}><ArrowRightLeft size={16} className="mr-2" /> Confirm Swap</Button>
                        </div>
                    </div>
                </div>
            );
        };

        const UserModal = ({ userToEdit, onSave, onClose, dialogs }) => {
            const [formData, setFormData] = useState({ username: '', password: '', name: '', role: ROLES.OPERATOR });
            const [showPassword, setShowPassword] = useState(false);

            useEffect(() => { if(userToEdit) setFormData(userToEdit); }, [userToEdit]);
            const handleSave = () => {
                if(!formData.username || !formData.password || !formData.name) { dialogs.showAlert("Please fill in all fields"); return; }
                onSave(formData);
            };
            return (
                <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
                    <div className="bg-white rounded-lg shadow-xl w-full max-w-md p-6">
                        <h3 className="text-xl font-bold mb-4">{userToEdit ? 'Edit User' : 'Add New User'}</h3>
                        <Input label="Full Name" value={formData.name} onChange={e => setFormData({...formData, name: e.target.value})} />
                        <Input label="Username" value={formData.username} onChange={e => setFormData({...formData, username: e.target.value})} />
                        
                        <div className="mb-4">
                            <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Password</label>
                            <div className="relative">
                                <input 
                                    className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 text-sm pr-10" 
                                    type={showPassword ? "text" : "password"} 
                                    value={formData.password} 
                                    onChange={e => setFormData({...formData, password: e.target.value})} 
                                
                                />
                                <button 
                                    type="button" 
                                    onClick={() => setShowPassword(!showPassword)} 
                                    className="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600"
                                >
                                    {showPassword ? <EyeOff size={16} /> : <Eye size={16} />}
                                </button>
                            </div>
                        </div>

                        <Select label="Role" value={formData.role} onChange={e => setFormData({...formData, role: e.target.value})} options={Object.values(ROLES).map(r => ({ label: r, value: r }))} />
                        <div className="flex justify-end gap-2 mt-6">
                            <Button variant="secondary" onClick={onClose}>Cancel</Button>
                            <Button onClick={handleSave}>Save User</Button>
                        </div>
                    </div>
                </div>
            );
        };

        const ProfileModal = ({ user, onUpdate, onClose, dialogs }) => {
            const [newName, setNewName] = useState(user.name);
            const [newPass, setNewPass] = useState(user.password);
            const [showPassword, setShowPassword] = useState(false);
            const handleSave = () => {
                dialogs.showConfirm("Are you sure you want to update your profile?", () => {
                    onUpdate({ ...user, name: newName, password: newPass });
                    onClose();
                });
            };
            return (
                <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
                    <div className="bg-white rounded-lg shadow-xl w-full max-w-md p-6">
                        <h2 className="text-xl font-bold mb-4">Profile Settings</h2>
                        <Input label="Display Name" value={newName} onChange={e => setNewName(e.target.value)} />
                        <div className="mb-4">
                            <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Password</label>
                            <div className="relative">
                                <input className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 text-sm pr-10" type={showPassword ? "text" : "password"} value={newPass} onChange={e => setNewPass(e.target.value)} />
                                <button type="button" onClick={() => setShowPassword(!showPassword)} className="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600">
                                    {showPassword ? <EyeOff size={16} /> : <Eye size={16} />}
                                </button>
                            </div>
                        </div>
                        <div className="flex justify-end gap-2 mt-6">
                            <Button variant="secondary" onClick={onClose}>Cancel</Button>
                            <Button onClick={handleSave}>Save Changes</Button>
                        </div>
                    </div>
                </div>
            )
        };

        const UserCard = ({ user, onEdit, onDelete }) => {
            const [showPassword, setShowPassword] = useState(false);
            return (
                <Card className="p-4 flex flex-col justify-between">
                    <div>
                        <div className="flex justify-between items-start">
                            <div className="flex items-center gap-3">
                                <div className="bg-indigo-100 p-2 rounded-full text-indigo-600"><User size={20} /></div>
                                <div><h4 className="font-bold text-gray-900">{user.name}</h4><p className="text-xs text-gray-500">@{user.username}</p></div>
                            </div>
                            <div className="flex gap-2">
                                <button onClick={() => onEdit(user)} className="text-gray-400 hover:text-indigo-600"><Edit size={16}/></button>
                                <button onClick={() => onDelete(user.id)} className="text-gray-400 hover:text-red-600"><Trash2 size={16}/></button>
                            </div>
                        </div>
                        <div className="mt-4 flex items-center gap-2 text-xs text-gray-600 bg-gray-50 p-2 rounded"><Shield size={12} className="text-indigo-500" />{user.role}</div>
                    </div>
                    <div className="mt-2 pt-2 border-t border-gray-100 flex items-center justify-between text-xs text-gray-400">
                        <div className="flex items-center gap-2"><Key size={12} /> <span>Password: {showPassword ? user.password : '••••••••'}</span></div>
                        <button onClick={() => setShowPassword(!showPassword)} className="text-indigo-500 hover:text-indigo-700">{showPassword ? <EyeOff size={14}/> : <Eye size={14}/>}</button>
                    </div>
                </Card>
            )
        }

        const ContentManager = ({ targetId, targetName, type, data, setData, dialogs, logAction, initialMode = 'view', onClose }) => {
            const [mode, setMode] = useState(initialMode); 
            const [selectedItems, setSelectedItems] = useState([]); 
            const [transferTarget, setTransferTarget] = useState('');
            const [swapTarget, setSwapTarget] = useState('');

            const currentItems = data.items.filter(i => i.locationId === targetId);
            const availableItems = data.items.filter(i => i.location === 'Unassigned' && i.status !== 'Pullout');

            const groupedAvailableItems = useMemo(() => {
                const groups = {};
                availableItems.forEach(item => {
                    const cat = item.category || 'Uncategorized';
                    const sub = item.subCategory || 'General';
                    if (!groups[cat]) groups[cat] = {};
                    if (!groups[cat][sub]) groups[cat][sub] = [];
                    groups[cat][sub].push(item);
                });
                return groups;
            }, [availableItems]);

            const groupedCurrentItems = useMemo(() => {
                const groups = {};
                currentItems.forEach(item => {
                    const cat = item.category || 'Uncategorized';
                    const sub = item.subCategory || 'General';
                    if (!groups[cat]) groups[cat] = {};
                    if (!groups[cat][sub]) groups[cat][sub] = [];
                    groups[cat][sub].push(item);
                });
                return groups;
            }, [currentItems]);

            const handleToggleSelect = (itemId) => {
                if (selectedItems.includes(itemId)) setSelectedItems(prev => prev.filter(id => id !== itemId));
                else setSelectedItems(prev => [...prev, itemId]);
            };

            const handleAddItems = () => {
                if (selectedItems.length === 0) return;
                dialogs.showConfirm(`Add ${selectedItems.length} items to ${targetName}?`, () => {
                    setData(prev => ({
                        ...prev,
                        items: prev.items.map(i => selectedItems.includes(i.id) ? { ...i, location: targetName, locationId: targetId, type: type } : i)
                    }));
                    
                    // Enhanced Log with Item Details
                    const itemDetails = data.items.filter(i => selectedItems.includes(i.id)).map(i => `[${i.id}] ${i.name}`).join(', ');
                    logAction('Batch Add', `Moved ${selectedItems.length} items to ${targetName}: ${itemDetails}`);
                    
                    setMode('view');
                    setSelectedItems([]);
                });
            };

            const handleRemoveItem = (itemId) => {
                dialogs.showConfirm(`Remove item ${itemId} from ${targetName}?`, () => {
                    setData(prev => ({
                        ...prev,
                        items: prev.items.map(i => i.id === itemId ? { ...i, location: 'Unassigned', locationId: '', type: 'none' } : i)
                    }));
                    logAction('Remove Item', `Removed item ${itemId} from ${targetName}`);
                });
            };

            const handleTransferSelected = () => {
                if (!transferTarget || selectedItems.length === 0) { dialogs.showAlert("Please select items and a destination."); return; }
                
                let tName = '';
                let tType = 'none';
                let tStatus = 'Active';
                let tLocationId = transferTarget;

                if (transferTarget === 'INVENTORY') {
                    tName = 'Unassigned';
                    tType = 'none';
                    tStatus = 'Active';
                    tLocationId = '';
                } else if (transferTarget === 'PULLOUT') {
                    tName = 'Pullout';
                    tType = 'none';
                    tStatus = 'Pullout';
                    tLocationId = 'pullout';
                } else {
                    const tRoom = data.floors.flatMap(f => f.rooms).find(r => r.id === transferTarget);
                    const tBox = data.boxes.find(b => b.id === transferTarget);
                    
                    if (tRoom) {
                        tName = tRoom.name;
                        tType = 'room';
                    } else if (tBox) {
                        tName = tBox.name;
                        tType = 'box';
                    }
                }

                if (!tName) return;

                dialogs.showConfirm(`Transfer ${selectedItems.length} items to ${tName}?`, () => {
                    setData(prev => ({
                        ...prev,
                        items: prev.items.map(i => selectedItems.includes(i.id) ? { 
                            ...i, 
                            location: tName, 
                            locationId: tLocationId, 
                            type: tType,
                            status: tStatus 
                        } : i)
                    }));
                    
                    // Enhanced Log with Item Details
                    const itemDetails = data.items.filter(i => selectedItems.includes(i.id)).map(i => `[${i.id}] ${i.name}`).join(', ');
                    logAction('Transfer Selected', `Transferred ${selectedItems.length} items from ${targetName} to ${tName}: ${itemDetails}`);
                    
                    setMode('view');
                    setSelectedItems([]);
                });
            };

            const handleSwapAll = () => {
                if (!swapTarget) { dialogs.showAlert("Please select a target to swap with."); return; }
                const room = data.floors.flatMap(f => f.rooms).find(r => r.id === swapTarget);
                const box = data.boxes.find(b => b.id === swapTarget);
                let targetNameStr = room ? room.name : box ? box.name : '';
                let targetTypeStr = room ? 'room' : box ? 'box' : '';

                dialogs.showConfirm(`CRITICAL: Swap ALL contents between ${targetName} and ${targetNameStr}?`, () => {
                    setData(prev => ({
                        ...prev,
                        items: prev.items.map(i => {
                            if (i.locationId === targetId) return { ...i, locationId: swapTarget, location: targetNameStr, type: targetTypeStr };
                            else if (i.locationId === swapTarget) return { ...i, locationId: targetId, location: targetName, type: type };
                            return i;
                        })
                    }));
                    logAction('Swap Content', `Swapped items between ${targetName} and ${targetNameStr}`);
                    setMode('view');
                });
            };

            const handleToggleCondition = (itemId, currentCondition) => {
                const newCondition = currentCondition === 'Working' ? 'Defective' : 'Working';
                dialogs.showConfirm(`Mark item ${itemId} as ${newCondition}?`, () => {
                    setData(prev => ({
                        ...prev,
                        items: prev.items.map(i => i.id === itemId ? { ...i, condition: newCondition } : i)
                    }));
                    logAction('Condition Change', `Item ${itemId} marked as ${newCondition} in ${targetName}`);
                });
            };

            return (
                <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
                    <div className="bg-white rounded-xl shadow-2xl w-full max-w-2xl flex flex-col max-h-[90vh]">
                        <div className="p-4 border-b flex justify-between items-center bg-gray-50 rounded-t-xl">
                            <div><h3 className="text-lg font-bold">Managing: {targetName}</h3><p className="text-xs text-gray-500">{currentItems.length} items assigned</p></div>
                            <button onClick={onClose} className="text-gray-400 hover:text-gray-600"><X /></button>
                        </div>
                        <div className="p-4 border-b flex gap-2 overflow-x-auto">
                            <Button size="sm" variant={mode === 'view' ? 'primary' : 'secondary'} onClick={() => {setMode('view'); setSelectedItems([]);}}><Eye size={14} /> View</Button>
                            <Button size="sm" variant={mode === 'add' ? 'primary' : 'secondary'} onClick={() => {setMode('add'); setSelectedItems([]);}}><Plus size={14} /> Add Items</Button>
                            <Button size="sm" variant={mode === 'transfer' ? 'primary' : 'secondary'} onClick={() => {setMode('transfer'); setSelectedItems([]);}}><Truck size={14} /> Transfer</Button>
                            {type !== 'room' && <Button size="sm" variant={mode === 'swap' ? 'primary' : 'secondary'} onClick={() => {setMode('swap'); setSelectedItems([]);}}><ArrowRightLeft size={14} /> Swap All</Button>}
                        </div>
                        <div className="flex-1 overflow-y-auto p-4">
                            {mode === 'view' && (
                                <div className="space-y-2">
                                    {currentItems.length > 0 ? (
                                        Object.keys(groupedCurrentItems).sort().map(cat => (
                                            <div key={cat} className="mb-4 border rounded-lg overflow-hidden">
                                                <div className="bg-gray-100 px-4 py-2 font-bold text-xs text-gray-700 uppercase tracking-wider border-b border-gray-200">{cat}</div>
                                                {Object.keys(groupedCurrentItems[cat]).sort().map(sub => (
                                                    <div key={sub}>
                                                        <div className="bg-gray-50 px-4 py-1.5 text-[11px] font-bold text-gray-500 pl-6 border-b border-gray-100 uppercase tracking-wide flex justify-between">
                                                            <span>{sub}</span>
                                                            <span className="text-gray-400">{groupedCurrentItems[cat][sub].length} items</span>
                                                        </div>
                                                        <div className="divide-y divide-gray-50">
                                                            {groupedCurrentItems[cat][sub].map(item => (
                                                                <div key={item.id} className="flex justify-between items-center p-2 pl-8 hover:bg-gray-50">
                                                                    <div className="flex items-center gap-3">
                                                                        <span className="font-mono text-xs bg-indigo-50 text-indigo-600 px-1 rounded">{item.id}</span>
                                                                        <div className="flex flex-col items-start gap-1">
                                                                            <span className="font-medium text-sm">{item.name}</span>
                                                                            <button onClick={() => handleToggleCondition(item.id, item.condition)} className={`px-1.5 py-0.5 rounded border text-[10px] ${item.condition === 'Defective' ? 'bg-red-50 text-red-600 border-red-200' : 'bg-green-50 text-green-600 border-green-200'} hover:opacity-80 transition-opacity`} title="Click to toggle condition">{item.condition || 'Working'}</button>
                                                                        </div>
                                                                    </div>
                                                                    <Button size="sm" variant="danger" onClick={() => handleRemoveItem(item.id)}><LogOut size={12} /> Remove</Button>
                                                                </div>
                                                            ))}
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        ))
                                    ) : <div className="text-center py-10 text-gray-400"><Box size={40} className="mx-auto mb-2 opacity-20" /><p>This location is empty.</p></div>}
                                </div>
                            )}
                            {mode === 'add' && (
                                <div className="space-y-4">
                                    <div className="flex justify-between items-center"><p className="text-sm font-bold">Select items to add from Inventory:</p><span className="text-xs text-gray-500">{selectedItems.length} selected</span></div>
                                    <div className="border rounded-lg max-h-[60vh] overflow-y-auto bg-white shadow-inner">
                                        {availableItems.length > 0 ? (
                                            Object.keys(groupedAvailableItems).sort().map(cat => (
                                                <div key={cat} className="border-b last:border-0">
                                                    <div className="bg-gray-100 px-4 py-2 font-bold text-xs text-gray-700 uppercase tracking-wider sticky top-0 z-10 shadow-sm border-b border-gray-200">{cat}</div>
                                                    {Object.keys(groupedAvailableItems[cat]).sort().map(sub => (
                                                        <div key={sub}>
                                                            <div className="bg-gray-50 px-4 py-1.5 text-[11px] font-bold text-gray-500 pl-6 border-b border-gray-100 uppercase tracking-wide">{sub}</div>
                                                            <div className="divide-y divide-gray-50">
                                                                {groupedAvailableItems[cat][sub].map(item => (
                                                                    <div key={item.id} className={`py-2 px-4 pl-8 flex items-center gap-3 cursor-pointer transition-colors ${selectedItems.includes(item.id) ? 'bg-indigo-50' : 'hover:bg-gray-50'}`} onClick={() => handleToggleSelect(item.id)}>
                                                                        {selectedItems.includes(item.id) ? <CheckSquare size={16} className="text-indigo-600 shrink-0"/> : <Square size={16} className="text-gray-300 shrink-0"/>}
                                                                        <span className="font-mono text-xs text-gray-400 shrink-0 w-16">{item.id}</span>
                                                                        <span className="text-sm font-medium text-gray-700">{item.name}</span>
                                                                    </div>
                                                                ))}
                                                            </div>
                                                        </div>
                                                    ))}
                                                </div>
                                            ))
                                        ) : (
                                            <div className="p-8 text-center text-gray-400 italic">
                                                <Box size={40} className="mx-auto mb-2 opacity-20" />
                                                <p>No available items in inventory.</p>
                                            </div>
                                        )}
                                    </div>
                                    <Button className="w-full" onClick={handleAddItems} disabled={selectedItems.length === 0}>Confirm Add Selected Items</Button>
                                </div>
                            )}
                            {mode === 'transfer' && (
                                <div className="space-y-4">
                                    <div className="bg-blue-50 p-4 rounded-lg border border-blue-100"><h4 className="font-bold text-blue-900 mb-2">Transfer Selected Items</h4><p className="text-xs text-blue-700">Select items from <strong>{targetName}</strong> to move to another location.</p></div>
                                    <div className="border rounded-lg max-h-48 overflow-y-auto">
                                        {currentItems.length > 0 ? (
                                             Object.keys(groupedCurrentItems).sort().map(cat => (
                                                <div key={cat} className="border-b last:border-0">
                                                    <div className="bg-gray-100 px-4 py-2 font-bold text-xs text-gray-700 uppercase tracking-wider sticky top-0 z-10 shadow-sm border-b border-gray-200">{cat}</div>
                                                    {Object.keys(groupedCurrentItems[cat]).sort().map(sub => (
                                                        <div key={sub}>
                                                            <div className="bg-gray-50 px-4 py-1.5 text-[11px] font-bold text-gray-500 pl-6 border-b border-gray-100 uppercase tracking-wide">{sub}</div>
                                                            <div className="divide-y divide-gray-50">
                                                                {groupedCurrentItems[cat][sub].map(item => (
                                                                    <div key={item.id} className={`py-2 px-4 pl-8 flex items-center gap-3 cursor-pointer transition-colors ${selectedItems.includes(item.id) ? 'bg-indigo-50' : 'hover:bg-gray-50'}`} onClick={() => handleToggleSelect(item.id)}>
                                                                        {selectedItems.includes(item.id) ? <CheckSquare size={16} className="text-indigo-600 shrink-0"/> : <Square size={16} className="text-gray-300 shrink-0"/>}
                                                                        <span className="font-mono text-xs text-gray-400 shrink-0 w-16">{item.id}</span>
                                                                        <span className="text-sm font-medium text-gray-700">{item.name}</span>
                                                                    </div>
                                                                ))}
                                                            </div>
                                                        </div>
                                                    ))}
                                                </div>
                                            ))
                                        ) : <p className="p-4 text-center text-gray-400 italic">This location is empty.</p>}
                                    </div>
                                    <div className="pt-2">
                                        <div className="mb-4">
                                            <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Destination</label>
                                            <select 
                                                className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 text-sm"
                                                value={transferTarget} 
                                                onChange={e => setTransferTarget(e.target.value)}
                                            >
                                                <option value="">Select Destination...</option>
                                                
                                                <optgroup label="General">
                                                    <option value="INVENTORY">Active Inventory (Unassign)</option>
                                                    <option value="PULLOUT">Pullout / Disposal</option>
                                                </optgroup>

                                                {data.floors.map(floor => {
                                                    const availableRooms = floor.rooms.filter(r => r.id !== targetId);
                                                    if (availableRooms.length === 0) return null;
                                                    return (
                                                        <optgroup key={floor.id} label={`${floor.name} (${floor.code})`}>
                                                            {availableRooms.map(r => (
                                                                <option key={r.id} value={r.id}>Room: {r.name}</option>
                                                            ))}
                                                        </optgroup>
                                                    );
                                                })}

                                                {data.boxes.length > 0 && (
                                                    <optgroup label="Storage Boxes">
                                                        {data.boxes.filter(b => b.id !== targetId).map(b => (
                                                            <option key={b.id} value={b.id}>Box: {b.name}</option>
                                                        ))}
                                                    </optgroup>
                                                )}
                                            </select>
                                        </div>
                                        <Button className="w-full" onClick={handleTransferSelected} disabled={selectedItems.length === 0 || !transferTarget}>Transfer {selectedItems.length} Items</Button>
                                    </div>
                                </div>
                            )}
                            {mode === 'swap' && (
                                <div className="space-y-4 text-center py-4">
                                    <div className="bg-orange-50 p-4 rounded-lg border border-orange-200 inline-block mb-4"><AlertOctagon size={32} className="text-orange-500 mx-auto mb-2" /><p className="font-bold text-orange-800">Critical Action: Swap Content</p><p className="text-xs text-orange-700 mt-1 max-w-xs">This will exchange ALL items in <strong>{targetName}</strong> with the selected location.</p></div>
                                    <div className="mb-4 text-left">
                                        <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Select Target to Swap With</label>
                                        <select 
                                            className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 text-sm"
                                            value={swapTarget} 
                                            onChange={e => setSwapTarget(e.target.value)}
                                        >
                                            <option value="">Choose Target...</option>
                                            
                                            {data.floors.map(floor => {
                                                const availableRooms = floor.rooms.filter(r => r.id !== targetId);
                                                if (availableRooms.length === 0) return null;
                                                return (
                                                    <optgroup key={floor.id} label={`${floor.name} (${floor.code})`}>
                                                        {availableRooms.map(r => (
                                                            <option key={r.id} value={r.id}>Room: {r.name}</option>
                                                        ))}
                                                    </optgroup>
                                                );
                                            })}

                                            {data.boxes.length > 0 && (
                                                <optgroup label="Storage Boxes">
                                                    {data.boxes.filter(b => b.id !== targetId).map(b => (
                                                        <option key={b.id} value={b.id}>Box: {b.name}</option>
                                                    ))}
                                                </optgroup>
                                            )}
                                        </select>
                                    </div>
                                    <Button className="w-full" variant="danger" onClick={handleSwapAll} disabled={!swapTarget}>Confirm Swap Operation</Button>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const ReportGenerator = ({ data, dialogs }) => {
            const [filter, setFilter] = useState('All');
            const [sections, setSections] = useState({
                overview: true,
                storage: true,
                rooms: true,
                boxes: true
            });
            const [selectedRooms, setSelectedRooms] = useState(new Set());
            const [expandRooms, setExpandRooms] = useState(false);

            // Initialize all rooms selected by default on load
            useEffect(() => {
                const allIds = data.floors.flatMap(f => f.rooms.map(r => r.id));
                setSelectedRooms(new Set(allIds));
            }, [data.floors.length]); 

            useEffect(() => {
                if (!window.html2pdf) {
                    const script = document.createElement('script');
                    script.src = "https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js";
                    script.async = true;
                    document.body.appendChild(script);
                    return () => { document.body.removeChild(script); };
                }
            }, []);

            const toggleSection = (key) => setSections(p => ({...p, [key]: !p[key]}));
            
            const handleRoomToggle = (id) => {
                const next = new Set(selectedRooms);
                if(next.has(id)) next.delete(id);
                else next.add(id);
                setSelectedRooms(next);
            };

            const handleFloorToggle = (floor) => {
                const floorRoomIds = floor.rooms.map(r => r.id);
                const allSelected = floorRoomIds.every(id => selectedRooms.has(id));
                const next = new Set(selectedRooms);
                if (allSelected) {
                    floorRoomIds.forEach(id => next.delete(id));
                } else {
                    floorRoomIds.forEach(id => next.add(id));
                }
                setSelectedRooms(next);
            };

            const filteredItems = useMemo(() => {
                switch (filter) {
                    case 'Active': return data.items.filter(i => i.status === 'Active');
                    case 'Defective': return data.items.filter(i => i.condition === 'Defective');
                    case 'Pullout': return data.items.filter(i => i.status === 'Pullout');
                    default: return data.items;
                }
            }, [data.items, filter]);

            const { stats, storageGrouped, roomGrouped, boxGrouped } = useMemo(() => {
                // Stats based on Filtered Items
                const statsObj = {
                    total: filteredItems.length,
                    active: filteredItems.filter(i => i.status === 'Active').length,
                    defective: filteredItems.filter(i => i.condition === 'Defective').length,
                    pullout: filteredItems.filter(i => i.status === 'Pullout').length,
                    totalRooms: data.floors.reduce((acc, f) => acc + f.rooms.length, 0),
                    occupiedRooms: data.floors.reduce((acc, f) => acc + f.rooms.filter(r => r.status === 'Occupied').length, 0),
                    vacantRooms: data.floors.reduce((acc, f) => acc + f.rooms.filter(r => r.status === 'Vacant').length, 0),
                    maintenanceRooms: data.floors.reduce((acc, f) => acc + f.rooms.filter(r => r.status === 'Maintenance').length, 0),
                };

                const storageItems = sections.storage ? filteredItems.filter(i => i.location === 'Unassigned' && i.status !== 'Pullout') : [];
                const roomItems = sections.rooms ? filteredItems.filter(i => i.type === 'room') : [];
                const boxItems = sections.boxes ? filteredItems.filter(i => i.type === 'box') : [];

                const sGrouped = {};
                storageItems.forEach(i => {
                    if (!sGrouped[i.category]) sGrouped[i.category] = {};
                    if (!sGrouped[i.category][i.subCategory]) sGrouped[i.category][i.subCategory] = [];
                    sGrouped[i.category][i.subCategory].push(i);
                });

                const rGrouped = {};
                if (sections.rooms) {
                    data.floors.forEach(floor => {
                        // Filter rooms based on selection
                        const selectedFloorRooms = floor.rooms.filter(r => selectedRooms.has(r.id));
                        
                        selectedFloorRooms.forEach(room => {
                            const itemsInRoom = roomItems.filter(i => i.locationId === room.id);
                            
                            if (itemsInRoom.length > 0) {
                                // Group by Category > SubCategory
                                const groupedItems = {};
                                itemsInRoom.forEach(item => {
                                    const cat = item.category || 'Uncategorized';
                                    const sub = item.subCategory || 'General';
                                    if (!groupedItems[cat]) groupedItems[cat] = {};
                                    if (!groupedItems[cat][sub]) groupedItems[cat][sub] = [];
                                    groupedItems[cat][sub].push(item);
                                });

                                if (!rGrouped[floor.name]) rGrouped[floor.name] = [];
                                rGrouped[floor.name].push({ room, groupedItems });
                            }
                        });
                    });
                }

                const bGrouped = [];
                if (sections.boxes) {
                    data.boxes.forEach(box => {
                        const itemsInBox = boxItems.filter(i => i.locationId === box.id);
                        if (itemsInBox.length > 0) bGrouped.push({ box, items: itemsInBox });
                    });
                }

                return { stats: statsObj, storageGrouped: sGrouped, roomGrouped: rGrouped, boxGrouped: bGrouped };
            }, [filteredItems, data.floors, data.boxes, sections, selectedRooms]);

            const handleDownloadPDF = () => {
                const element = document.getElementById('report-content');
                if (window.html2pdf) {
                    const opt = { 
                        margin: 10, // Standard margins (10mm ~ 0.4in)
                        filename: `IMS_Report_${new Date().toISOString().split('T')[0]}.pdf`, 
                        image: { type: 'jpeg', quality: 0.98 }, 
                        html2canvas: { scale: 2, useCORS: true }, 
                        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
                        pagebreak: { mode: ['avoid-all', 'css', 'legacy'] }
                    };
                    window.html2pdf().set(opt).from(element).save();
                } else {
                    if(dialogs && dialogs.showAlert) {
                        dialogs.showAlert("PDF Generator is loading... Please try again in a moment.");
                    }
                }
            };

            return (
                <div className="p-4 lg:p-8 space-y-6 animate-in fade-in bg-white min-h-[500px]">
                   {/* Configuration Panel */}
                   <div className="bg-white p-6 rounded-xl border border-gray-200 shadow-sm print:hidden space-y-6">
                        <div className="flex justify-between items-center border-b pb-4">
                            <h3 className="font-bold text-lg text-gray-800 flex items-center gap-2"><FileText size={20}/> Report Configuration</h3>
                            <Button onClick={handleDownloadPDF}><Download size={16} className="mr-2"/> Download PDF</Button>
                        </div>
                        
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label className="block text-xs font-bold text-gray-500 uppercase mb-2">Item Filter</label>
                                <select className="w-full border border-gray-300 rounded p-2 text-sm outline-none focus:ring-2 focus:ring-indigo-500" value={filter} onChange={e => setFilter(e.target.value)}>
                                    <option value="All">All Items</option>
                                    <option value="Active">Active Only</option>
                                    <option value="Defective">Defective Only</option>
                                    <option value="Pullout">Pullout / Disposal</option>
                                </select>
                            </div>
                            <div>
                                <label className="block text-xs font-bold text-gray-500 uppercase mb-2">Included Sections</label>
                                <div className="grid grid-cols-2 gap-3">
                                    <label className="flex items-center gap-2 text-sm cursor-pointer select-none">
                                        <input type="checkbox" checked={sections.overview} onChange={() => toggleSection('overview')} className="rounded text-indigo-600 focus:ring-indigo-500"/> Overview Stats
                                    </label>
                                    <label className="flex items-center gap-2 text-sm cursor-pointer select-none">
                                        <input type="checkbox" checked={sections.storage} onChange={() => toggleSection('storage')} className="rounded text-indigo-600 focus:ring-indigo-500"/> Storage Inventory
                                    </label>
                                    <label className="flex items-center gap-2 text-sm cursor-pointer select-none">
                                        <input type="checkbox" checked={sections.boxes} onChange={() => toggleSection('boxes')} className="rounded text-indigo-600 focus:ring-indigo-500"/> Box Allocations
                                    </label>
                                    <label className="flex items-center gap-2 text-sm cursor-pointer select-none">
                                        <input type="checkbox" checked={sections.rooms} onChange={() => toggleSection('rooms')} className="rounded text-indigo-600 focus:ring-indigo-500"/> Room Allocations
                                    </label>
                                </div>
                            </div>
                        </div>

                        {sections.rooms && (
                            <div className="border border-gray-200 rounded-lg p-4 bg-gray-50">
                                <div className="flex justify-between items-center mb-2 cursor-pointer" onClick={() => setExpandRooms(!expandRooms)}>
                                    <h4 className="font-bold text-sm text-gray-700">Specific Room Selection ({selectedRooms.size} selected)</h4>
                                    {expandRooms ? <ChevronDown size={16}/> : <ChevronRight size={16}/>}
                                </div>
                                {expandRooms && (
                                    <div className="space-y-4 mt-4 animate-in fade-in max-h-60 overflow-y-auto">
                                        {data.floors.map(floor => (
                                            <div key={floor.id} className="bg-white border border-gray-200 rounded p-3">
                                                <div className="flex items-center gap-2 mb-2 pb-2 border-b border-gray-100">
                                                    <input type="checkbox" 
                                                        checked={floor.rooms.every(r => selectedRooms.has(r.id))}
                                                        onChange={() => handleFloorToggle(floor)}
                                                        className="rounded text-indigo-600"
                                                    />
                                                    <span className="font-bold text-sm">{floor.name}</span>
                                                </div>
                                                <div className="grid grid-cols-2 md:grid-cols-3 gap-2 pl-6">
                                                    {floor.rooms.map(room => (
                                                        <label key={room.id} className="flex items-center gap-2 text-xs cursor-pointer hover:bg-gray-50 rounded p-1">
                                                            <input type="checkbox" checked={selectedRooms.has(room.id)} onChange={() => handleRoomToggle(room.id)} className="rounded text-indigo-600"/>
                                                            <span className="truncate">{room.name}</span>
                                                        </label>
                                                    ))}
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                        )}
                   </div>

                   {/* Preview / Print Area */}
                   <div className="overflow-x-auto border border-gray-200 rounded-lg shadow-sm bg-gray-500/10 p-4">
                        {/* Wrapper for Preview Visualization (A4 Constraints) */}
                        <div className="mx-auto shadow-xl print:shadow-none bg-white relative" style={{ width: '210mm', minHeight: '297mm' }}>
                            {/* Actual Printable Content (Fluid width to allow PDF scaling without cuts) */}
                            <div id="report-content" className="bg-white text-left w-full p-8">
                                {/* Header */}
                                <div className="flex justify-between items-end border-b-2 border-gray-900 pb-4 mb-8 break-inside-avoid">
                                    <div>
                                        <h1 className="text-3xl font-black text-gray-900 tracking-tight uppercase">Inventory Report</h1>
                                        <p className="text-gray-500 font-medium mt-1 uppercase tracking-widest text-xs">Filter: {filter} • {new Date().toLocaleDateString()}</p>
                                    </div>
                                    <div className="text-right">
                                        <h2 className="text-xl font-bold text-gray-400">IMS</h2>
                                        <p className="text-xs text-gray-400">Operation Department</p>
                                    </div>
                                </div>

                                {/* Stats */}
                                {sections.overview && (
                                    <div className="space-y-4 mb-8 break-inside-avoid">
                                        {/* Inventory Stats */}
                                        <div className="grid grid-cols-4 gap-4">
                                            <div className="p-3 bg-gray-50 border border-gray-200 rounded text-center"><p className="text-[10px] font-bold text-gray-500 uppercase">Total Items</p><p className="text-xl font-black text-gray-900">{stats.total}</p></div>
                                            <div className="p-3 bg-green-50 border border-green-100 rounded text-center"><p className="text-[10px] font-bold text-green-700 uppercase">Active</p><p className="text-xl font-black text-green-700">{stats.active}</p></div>
                                            <div className="p-3 bg-red-50 border border-red-100 rounded text-center"><p className="text-[10px] font-bold text-red-700 uppercase">Defective</p><p className="text-xl font-black text-red-700">{stats.defective}</p></div>
                                            <div className="p-3 bg-orange-50 border border-orange-100 rounded text-center"><p className="text-[10px] font-bold text-orange-700 uppercase">Disposal</p><p className="text-xl font-black text-orange-700">{stats.pullout}</p></div>
                                        </div>

                                        {/* Room Stats */}
                                        <div className="grid grid-cols-4 gap-4">
                                            <div className="p-3 bg-gray-50 border border-gray-200 rounded text-center"><p className="text-[10px] font-bold text-gray-500 uppercase">Total Rooms</p><p className="text-xl font-black text-gray-900">{stats.totalRooms}</p></div>
                                            <div className="p-3 bg-blue-50 border border-blue-100 rounded text-center"><p className="text-[10px] font-bold text-blue-700 uppercase">Occupied</p><p className="text-xl font-black text-blue-700">{stats.occupiedRooms}</p></div>
                                            <div className="p-3 bg-emerald-50 border border-emerald-100 rounded text-center"><p className="text-[10px] font-bold text-emerald-700 uppercase">Vacant</p><p className="text-xl font-black text-emerald-700">{stats.vacantRooms}</p></div>
                                            <div className="p-3 bg-yellow-50 border border-yellow-100 rounded text-center"><p className="text-[10px] font-bold text-yellow-700 uppercase">Maintenance</p><p className="text-xl font-black text-yellow-700">{stats.maintenanceRooms}</p></div>
                                        </div>
                                    </div>
                                )}

                                {/* Storage */}
                                {sections.storage && (
                                    <div className="mb-8 break-inside-avoid">
                                        <h3 className="font-bold text-white bg-gray-900 px-4 py-1.5 uppercase tracking-wider text-xs rounded-t-lg">Storage Inventory</h3>
                                        <div className="border border-gray-200 border-t-0 rounded-b-lg p-4 bg-white">
                                            {Object.keys(storageGrouped).length === 0 ? <p className="text-gray-400 text-xs italic">No items found.</p> : Object.keys(storageGrouped).map(cat => (
                                                <div key={cat} className="mb-4 last:mb-0 break-inside-avoid">
                                                    <h4 className="font-bold text-indigo-700 border-b border-indigo-100 pb-1 mb-2 text-xs">{cat}</h4>
                                                    {Object.keys(storageGrouped[cat]).map(sub => {
                                                        const items = storageGrouped[cat][sub];
                                                        const counts = items.reduce((acc, i) => { acc[i.name] = (acc[i.name] || 0) + 1; return acc; }, {});
                                                        return (
                                                            <div key={sub} className="mb-2 ml-2 break-inside-avoid">
                                                                <div className="flex justify-between items-end mb-1">
                                                                    <h5 className="font-semibold text-[10px] text-gray-600 uppercase tracking-wide">{sub}</h5>
                                                                </div>
                                                                <table className="w-full text-[10px] text-left"><tbody>{Object.entries(counts).map(([name, count]) => <tr key={name} className="border-b border-gray-50"><td className="py-0.5 px-2">{name}</td><td className="py-0.5 px-2 text-right font-mono font-bold">{count}</td></tr>)}</tbody></table>
                                                            </div>
                                                        );
                                                    })}
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                )}

                                {/* Rooms */}
                                {sections.rooms && (
                                    <div className="mb-8 break-inside-avoid">
                                        <h3 className="font-bold text-white bg-gray-900 px-4 py-1.5 uppercase tracking-wider text-xs rounded-t-lg">Room Allocations</h3>
                                        <div className="border border-gray-200 border-t-0 rounded-b-lg p-4 bg-white">
                                            {Object.keys(roomGrouped).length === 0 ? <p className="text-gray-400 text-xs italic">No items or no rooms selected.</p> : Object.keys(roomGrouped).map(floor => (
                                                <div key={floor} className="mb-6 last:mb-0 break-inside-avoid">
                                                    <h4 className="font-bold text-indigo-700 border-b border-indigo-100 pb-1 mb-2 text-xs">{floor}</h4>
                                                    <div className="grid grid-cols-2 gap-3">
                                                        {roomGrouped[floor].map(({ room, groupedItems }) => (
                                                            <div key={room.id} className="border border-gray-200 rounded p-2 break-inside-avoid">
                                                                <div className="flex justify-between items-center mb-1 border-b border-gray-100 pb-1">
                                                                    <span className="font-bold text-xs">{room.name}</span>
                                                                    <span className="text-[9px] text-gray-400 font-mono">{room.id}</span>
                                                                </div>
                                                                {Object.keys(groupedItems).sort().map(cat => (
                                                                    <div key={cat} className="mt-1">
                                                                        <div className="text-[9px] font-bold text-gray-600 bg-gray-50 px-1 rounded-sm mb-0.5">{cat}</div>
                                                                        {Object.keys(groupedItems[cat]).sort().map(sub => (
                                                                            <div key={sub} className="mb-1 pl-1">
                                                                                <div className="text-[8px] font-semibold text-gray-400 uppercase tracking-wide mb-0.5 pl-1">{sub}</div>
                                                                                <ul className="text-[9px] space-y-0.5 pl-1 border-l-2 border-gray-100 ml-0.5">
                                                                                    {groupedItems[cat][sub].map(item => (
                                                                                        <li key={item.id} className="flex justify-between items-baseline">
                                                                                            <span className="truncate pr-1">{item.name}</span>
                                                                                            <span className="text-[8px] text-gray-400 shrink-0 font-mono">{item.id}</span>
                                                                                        </li>
                                                                                    ))}
                                                                                </ul>
                                                                            </div>
                                                                        ))}
                                                                    </div>
                                                                ))}
                                                            </div>
                                                        ))}
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                )}

                                {/* Boxes */}
                                {sections.boxes && (
                                    <div className="mb-8 break-inside-avoid">
                                        <h3 className="font-bold text-white bg-gray-900 px-4 py-1.5 uppercase tracking-wider text-xs rounded-t-lg">Box Allocations</h3>
                                        <div className="border border-gray-200 border-t-0 rounded-b-lg p-4 bg-white">
                                            {boxGrouped.length === 0 ? <p className="text-gray-400 text-xs italic">No items found.</p> : <div className="grid grid-cols-3 gap-3">
                                                {boxGrouped.map(({ box, items }) => (
                                                    <div key={box.id} className="border border-gray-200 rounded p-2 break-inside-avoid">
                                                        <div className="flex justify-between items-center mb-1 border-b border-gray-100 pb-1 bg-orange-50 -m-2 p-2 rounded-t">
                                                            <span className="font-bold text-xs text-orange-900">{box.name}</span>
                                                            <span className="text-[9px] text-orange-400 font-mono">{box.id}</span>
                                                        </div>
                                                        <ul className="text-[10px] space-y-0.5 mt-2">
                                                            {items.map(item => (
                                                                <li key={item.id} className="flex justify-between">
                                                                    <span className="truncate pr-2">{item.name}</span>
                                                                    <span className="font-mono text-gray-400 shrink-0">{item.id}</span>
                                                                </li>
                                                            ))}
                                                        </ul>
                                                    </div>
                                                ))}
                                            </div>}
                                        </div>
                                    </div>
                                )}
                                
                                {/* Footer */}
                                <div className="mt-8 flex justify-between text-[10px] text-gray-400 pt-4 border-t border-gray-200 break-inside-avoid">
                                    <div><p className="mb-4">Prepared By: ___________________________</p></div>
                                    <div><p className="mb-4">Verified By: ___________________________</p></div>
                                </div>
                            </div>
                        </div>
                   </div>
                </div>
            )
        };

        const LoginView = ({ onLogin, users }) => {
            const [username, setUsername] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');

            const handleSubmit = (e) => {
              e.preventDefault();
              // Authenticate against the users list passed from App data
              const foundUser = users.find(u => u.username === username && u.password === password);
              if (foundUser) {
                onLogin(foundUser);
              } else {
                setError('Invalid credentials');
              }
            };

            return (
              <div className="min-h-screen bg-white flex items-center justify-center p-4">
                <div className="max-w-md w-full bg-white rounded-xl shadow-lg p-8 border border-gray-100">
                  <div className="text-center mb-8">
                    <div className="bg-indigo-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                      <img src="./icon-512.png" className="w-10 h-10 rounded-lg" alt="Logo" />
                    </div>
                    <h1 className="text-2xl font-bold text-gray-900">IMS</h1>
                    <p className="text-gray-500 mt-2">Inventory Management System</p>
                  </div>
                  <form onSubmit={handleSubmit} className="space-y-4">
                    <Input label="Username" value={username} onChange={e => setUsername(e.target.value)} placeholder="Username"/>
                    <Input label="Password" type="password" value={password} onChange={e => setPassword(e.target.value)} placeholder="Password" />
                    {error && <p className="text-red-500 text-sm">{error}</p>}
                    <Button className="w-full" type="submit">Sign In</Button>
                  </form>
                  <div className="mt-6 pt-6 border-t border-gray-100 text-xs text-gray-400 text-center">
                    <p className="font-semibold mb-2">Restricted Access</p>
                    <p>Please contact your Administrator for an account.</p>
                  </div>
                </div>
              </div>
            );
        };

        const DashboardView = ({ data }) => {
            const [selectedLog, setSelectedLog] = useState(null);
            
            const totalRooms = data.floors.reduce((acc, f) => acc + f.rooms.length, 0);
            const occupiedRooms = data.floors.reduce((acc, f) => acc + f.rooms.filter(r => r.status === 'Occupied').length, 0);
            const availableItems = data.items.filter(i => i.location === 'Unassigned' && i.status !== 'Pullout').length;
            const defectiveItems = data.items.filter(i => i.condition === 'Defective').length;

            const stats = [
              { label: 'Total Assets', value: data.items.length, icon: Package, color: 'blue' },
              { label: 'Available Stock', value: availableItems, icon: CheckCircle, color: 'green' },
              { label: 'Defective Items', value: defectiveItems, icon: AlertTriangle, color: 'red' },
              { label: 'Room Occupancy', value: `${occupiedRooms}/${totalRooms}`, icon: Layers, color: 'purple' },
            ];

            const recentLogs = data.logs.slice(0, 5);
            const catStats = data.categories.map(c => ({
                name: c.name,
                count: data.items.filter(i => i.category === c.name).length
            }));

            return (
              <div className="space-y-6">
                <h2 className="text-2xl font-bold text-gray-800">Dashboard</h2>
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                  {stats.map((stat, i) => (
                    <Card key={i} className="p-6 flex items-center gap-4">
                      <div className={`p-3 rounded-full bg-${stat.color}-100 text-${stat.color}-600`}>
                        <stat.icon className="w-6 h-6" />
                      </div>
                      <div>
                        <p className="text-sm text-gray-500">{stat.label}</p>
                        <p className="text-2xl font-bold text-gray-900">{stat.value}</p>
                      </div>
                    </Card>
                  ))}
                </div>

                <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                     <Card className="p-6 col-span-1">
                         <h3 className="font-bold text-lg mb-4 flex items-center gap-2"><LayoutGrid size={18} /> Room Status</h3>
                         <div className="space-y-4">
                             <div className="flex justify-between items-center p-3 bg-gray-50 rounded border border-gray-100"><span className="text-gray-700 font-medium">Total Rooms</span><span className="text-xl font-bold text-gray-900">{totalRooms}</span></div>
                             <div className="flex justify-between items-center p-3 bg-blue-50 rounded border border-blue-100"><span className="text-blue-900 font-medium">Occupied</span><span className="text-xl font-bold text-blue-700">{occupiedRooms}</span></div>
                             <div className="flex justify-between items-center p-3 bg-green-50 rounded border border-green-100"><span className="text-green-900 font-medium">Vacant</span><span className="text-xl font-bold text-green-700">{data.floors.reduce((acc, f) => acc + f.rooms.filter(r => r.status === 'Vacant').length, 0)}</span></div>
                             <div className="flex justify-between items-center p-3 bg-yellow-50 rounded border border-yellow-100"><span className="text-yellow-900 font-medium">Maintenance</span><span className="text-xl font-bold text-yellow-700">{data.floors.reduce((acc, f) => acc + f.rooms.filter(r => r.status === 'Maintenance').length, 0)}</span></div>
                         </div>
                     </Card>
                    
                    <Card className="p-6 col-span-1">
                        <h3 className="font-bold text-lg mb-4 flex items-center gap-2"><Activity size={18} /> Recent Activity</h3>
                        <div className="space-y-4">
                            {recentLogs.map(log => {
                                const hasDetails = log.details.includes(': [');
                                const summary = hasDetails ? log.details.split(':')[0] : log.details;
                                return (
                                    <div key={log.id} className="flex items-start gap-3 pb-3 border-b border-gray-100 last:border-0">
                                        <div className="w-2 h-2 mt-2 rounded-full bg-indigo-500 shrink-0" />
                                        <div className="flex-1 min-w-0">
                                            <p className="text-sm font-medium text-gray-900 truncate">{log.action}</p>
                                            <div className="flex justify-between items-start gap-2 mt-0.5">
                                                <p className="text-xs text-gray-500 line-clamp-2" title={summary}>{summary}</p>
                                                {hasDetails && (
                                                    <button onClick={() => setSelectedLog(log)} className="shrink-0 text-[10px] bg-indigo-50 text-indigo-600 px-2 py-0.5 rounded border border-indigo-100 hover:bg-indigo-100">
                                                        View
                                                    </button>
                                                )}
                                            </div>
                                            <p className="text-[10px] text-gray-400 mt-1">{new Date(log.timestamp).toLocaleString('en-US', { timeZone: 'Asia/Manila' })}</p>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    </Card>

                    <Card className="p-6 col-span-1"><h3 className="font-bold text-lg mb-4 flex items-center gap-2"><Layers size={18} /> Asset Distribution</h3><div className="space-y-3">{catStats.map(stat => (<div key={stat.name}><div className="flex justify-between text-xs mb-1"><span>{stat.name}</span><span className="font-medium">{stat.count}</span></div><div className="w-full bg-gray-100 rounded-full h-2"><div className="bg-indigo-600 h-2 rounded-full" style={{ width: `${(stat.count / Math.max(data.items.length, 1)) * 100}%` }}/></div></div>))}</div></Card>
                </div>
                
                {/* Reusing LogDetailsModal for Dashboard */}
                <LogDetailsModal log={selectedLog} onClose={() => setSelectedLog(null)} allItems={data.items} />
              </div>
            );
        };

        const StorageView = ({ data, setData, dialogs, logAction, hasAdminAccess }) => {
            const [viewMode, setViewMode] = useState('active'); 
            const [searchTerm, setSearchTerm] = useState('');
            const [expandedGroups, setExpandedGroups] = useState([]);
            const [newItemData, setNewItemData] = useState({ name: '', qty: 1, condition: 'Working' });
            const [addingToSub, setAddingToSub] = useState(null); 

            const filteredItems = useMemo(() => {
                return data.items.filter(item => {
                    if (viewMode === 'active') return item.status !== 'Pullout';
                    if (viewMode === 'pullout') return item.status === 'Pullout';
                    return true;
                });
            }, [data.items, viewMode]);

            const groupedItems = useMemo(() => {
                const groups = {};
                filteredItems.forEach(item => {
                    const key = item.name + '|' + item.subCategory + '|' + item.category;
                    if (!groups[key]) {
                        groups[key] = { name: item.name, sub: item.subCategory, cat: item.category, total: 0, available: 0, items: [] };
                    }
                    groups[key].total++;
                    if (item.location === 'Unassigned') groups[key].available++;
                    groups[key].items.push(item);
                });
                return groups;
            }, [filteredItems]);

            const getProductOptions = (cat, sub) => {
                const products = new Set();
                data.items.forEach(i => { if(i.category === cat && i.subCategory === sub) products.add(i.name); });
                return Array.from(products).map(p => ({ value: p, label: p }));
            };

            const handleBatchAdd = (cat, sub) => {
                if (!newItemData.name) { dialogs.showAlert("Please select a product."); return; }
                if (newItemData.qty < 1) { dialogs.showAlert("Quantity must be at least 1."); return; }
                dialogs.showConfirm(`WARNING: Add ${newItemData.qty} units of "${newItemData.name}"?`, () => {
                    const newItems = [];
                    let tempItems = [...data.items];
                    for(let i = 0; i < newItemData.qty; i++) {
                        const newId = generateId(newItemData.name, tempItems);
                        const item = { id: newId, name: newItemData.name, category: cat, subCategory: sub, location: 'Unassigned', locationId: '', type: 'none', status: 'Active', condition: newItemData.condition };
                        newItems.push(item);
                        tempItems.push(item);
                    }
                    setData(prev => ({ ...prev, items: [...prev.items, ...newItems] }));
                    logAction('Stock Added', `Added ${newItemData.qty}x ${newItemData.name}`);
                    setAddingToSub(null);
                    setNewItemData({ name: '', qty: 1, condition: 'Working' });
                });
            };

            const handleMoveToPullout = (itemId) => {
                dialogs.showConfirm("Move this item to Pullout/Disposal?", () => {
                    setData(prev => ({ ...prev, items: prev.items.map(i => i.id === itemId ? { ...i, status: 'Pullout', location: 'Pullout', locationId: 'pullout', type: 'none' } : i) }));
                    logAction('Pullout', `Item ${itemId} moved to Pullout`);
                });
            };

            const handleRestoreItem = (itemId) => {
                dialogs.showConfirm("Restore this item to Active Inventory?", () => {
                    setData(prev => ({ ...prev, items: prev.items.map(i => i.id === itemId ? { ...i, status: 'Active', location: 'Unassigned', locationId: '', type: 'none' } : i) }));
                    logAction('Restore', `Item ${itemId} restored to Active`);
                });
            };

            const handleToggleCondition = (itemId, currentCondition) => {
                const newCondition = currentCondition === 'Working' ? 'Defective' : 'Working';
                dialogs.showConfirm(`Mark item ${itemId} as ${newCondition}?`, () => {
                    setData(prev => ({ ...prev, items: prev.items.map(i => i.id === itemId ? { ...i, condition: newCondition } : i) }));
                    logAction('Condition Change', `Item ${itemId} marked as ${newCondition}`);
                });
            };

            return (
              <div className="space-y-6">
                <div className="flex flex-col md:flex-row justify-between items-center gap-4 bg-white p-4 rounded-lg shadow-sm border border-gray-100">
                  <div className="flex gap-2 w-full md:w-auto">
                      <button onClick={() => setViewMode('active')} className={`flex-1 md:flex-none px-4 py-2 rounded-lg font-medium text-sm text-center transition-colors ${viewMode === 'active' ? 'bg-indigo-600 text-white' : 'text-gray-600 hover:bg-gray-100'}`}>Active Inventory</button>
                      <button onClick={() => setViewMode('pullout')} className={`flex-1 md:flex-none px-4 py-2 rounded-lg font-medium text-sm text-center transition-colors ${viewMode === 'pullout' ? 'bg-red-600 text-white' : 'text-gray-600 hover:bg-gray-100'}`}>Pullout / Disposal</button>
                  </div>
                  <div className="relative w-full md:w-auto">
                      <Search className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 w-4 h-4" />
                      <input type="text" placeholder="Search..." className="pl-9 pr-4 py-2 border rounded-full text-sm w-full md:w-64 focus:ring-2 focus:ring-indigo-500 outline-none" value={searchTerm} onChange={e => setSearchTerm(e.target.value)}/>
                  </div>
                </div>
                <div className="space-y-6">
                    {data.categories.map(cat => (
                        <Card key={cat.id} className="overflow-hidden">
                            <div className="p-4 bg-gray-50 border-b border-gray-200"><h3 className="font-bold text-lg">{cat.name}</h3></div>
                            <div className="p-4 bg-white space-y-6">
                                {cat.subs.map(sub => {
                                    const subGroups = Object.values(groupedItems).filter(g => g.cat === cat.name && g.sub === sub && (searchTerm ? g.name.toLowerCase().includes(searchTerm.toLowerCase()) : true));
                                    if (subGroups.length === 0 && viewMode === 'pullout') return null;
                                    const productOptions = getProductOptions(cat.name, sub);
                                    return (
                                        <div key={sub} className="border-l-2 border-indigo-100 pl-4 ml-2">
                                            <div className="flex justify-between items-center mb-3">
                                                <h4 className="text-sm font-bold text-gray-500 uppercase tracking-wider">{sub}</h4>
                                                {hasAdminAccess && viewMode === 'active' && <Button size="sm" variant="ghost" onClick={() => setAddingToSub({cat: cat.name, sub})}><Plus size={14} /> Add Stock</Button>}
                                            </div>
                                            {addingToSub?.cat === cat.name && addingToSub?.sub === sub && (
                                                <div className="bg-indigo-50 p-4 rounded-lg mb-4 border border-indigo-100 shadow-inner animate-in fade-in">
                                                    <h5 className="font-bold text-sm mb-2 text-indigo-800 flex items-center gap-2"><Plus size={14} /> Add Stock to {sub}</h5>
                                                    {productOptions.length === 0 ? <div className="text-sm text-red-500 mb-2 flex items-center gap-2"><AlertTriangle size={14}/> No products registered. Go to Settings first.</div> : 
                                                    <div className="flex flex-col md:flex-row gap-3 items-end">
                                                        <div className="flex-1 w-full"><Select label="Select Product" className="mb-0" value={newItemData.name} onChange={e => setNewItemData({...newItemData, name: e.target.value})} options={[{ value: '', label: '-- Select Product --' }, ...productOptions]}/></div>
                                                        <div className="w-full md:w-32"><Select label="Condition" className="mb-0" value={newItemData.condition} onChange={e => setNewItemData({...newItemData, condition: e.target.value})} options={[{ value: 'Working', label: 'Working' }, { value: 'Defective', label: 'Defective' }]}/></div>
                                                        <div className="w-full md:w-24"><Input label="Qty" type="number" min="1" className="mb-0" value={newItemData.qty} onChange={e => setNewItemData({...newItemData, qty: parseInt(e.target.value) || 1})}/></div>
                                                    </div>}
                                                    <div className="flex gap-2 mt-4 justify-end"><Button size="sm" variant="secondary" onClick={() => { setAddingToSub(null); setNewItemData({name: '', qty: 1, condition: 'Working'}); }}>Cancel</Button><Button size="sm" onClick={() => handleBatchAdd(cat.name, sub)} disabled={productOptions.length === 0}>Confirm Add Stock</Button></div>
                                                </div>
                                            )}
                                            {subGroups.length > 0 ? (
                                                <div className="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-3">
                                                    {subGroups.map((group, idx) => {
                                                        const groupKey = group.name + group.sub;
                                                        const isExpanded = expandedGroups.includes(groupKey);
                                                        return (
                                                            <div key={idx} className={`border rounded-md p-3 transition-shadow ${group.available === 0 ? 'bg-gray-100 opacity-75' : 'bg-white hover:shadow-md'}`}>
                                                                <div className="flex justify-between items-start gap-2">
                                                                    <div className="min-w-0 flex-1"><p className="font-medium text-gray-900 truncate" title={group.name}>{group.name}</p><p className="text-xs text-gray-500 truncate">{group.sub}</p></div>
                                                                    <div className="text-right shrink-0">{viewMode === 'active' ? <>{group.available > 0 ? <Badge color="green">{group.available} Available</Badge> : <Badge color="red">No Stock</Badge>}<p className="text-[10px] text-gray-400 mt-1">Total Assets: {group.total}</p></> : <Badge color="red">Pullout</Badge>}</div>
                                                                </div>
                                                                {hasAdminAccess && (<div className="mt-3 pt-2 border-t border-gray-100"><button onClick={() => setExpandedGroups(prev => isExpanded ? prev.filter(k => k !== groupKey) : [...prev, groupKey])} className="text-xs text-indigo-600 flex items-center gap-1 hover:underline w-full justify-center">{isExpanded ? 'Hide Details' : 'View Details'}</button>{isExpanded && (<div className="mt-2 space-y-1 max-h-32 overflow-y-auto">{group.items.map(item => (<div key={item.id} className="flex justify-between items-center text-xs p-1 hover:bg-gray-50 rounded group"><div className="flex flex-col"><span className="font-mono">{item.id}</span>{viewMode === 'active' && <span className={item.location === 'Unassigned' ? 'text-green-600' : 'text-gray-400'}>{item.location}</span>}</div><div className="flex items-center gap-2"><button onClick={() => handleToggleCondition(item.id, item.condition)} className={`px-1.5 py-0.5 rounded border text-[10px] ${item.condition === 'Defective' ? 'bg-red-50 text-red-600 border-red-200' : 'bg-green-50 text-green-600 border-green-200'} hover:opacity-80 transition-opacity`}>{item.condition || 'Working'}</button>{viewMode === 'active' ? <button onClick={() => handleMoveToPullout(item.id)} className="p-1 text-gray-300 hover:text-red-500" title="Move to Pullout"><Archive size={12} /></button> : <button onClick={() => handleRestoreItem(item.id)} className="p-1 text-gray-300 hover:text-green-500" title="Restore to Active"><ArrowUpDown size={12} /></button>}</div></div>))}</div>)}</div>)}
                                                            </div>
                                                        );
                                                    })}
                                                </div>
                                            ) : <p className="text-xs text-gray-400 italic">No items found in this category.</p>}
                                        </div>
                                    )
                                })}
                            </div>
                        </Card>
                    ))}
                </div>
              </div>
            );
        };

        const FloorsView = ({ data, setData, dialogs, logAction, hasAdminAccess, setManagingContent }) => {
            const changeRoomStatus = (roomCode, newStatus) => {
                if (!hasAdminAccess) return;
                dialogs.showConfirm(`Change status of room ${roomCode} to ${newStatus}?`, () => {
                    setData(prev => ({
                        ...prev,
                        floors: prev.floors.map(f => ({
                            ...f,
                            rooms: f.rooms.map(r => r.id === roomCode ? { ...r, status: newStatus } : r)
                        }))
                    }));
                    logAction('Status Change', `Room ${roomCode} set to ${newStatus}`);
                });
            };

            const getStatusColor = (status) => {
                if (status === 'Vacant') return 'green';
                if (status === 'Occupied') return 'blue';
                return 'red';
            };

            return (
            <div className="space-y-6">
                <h2 className="text-2xl font-bold text-gray-800">Floors & Rooms</h2>
                {data.floors.map(floor => (
                    <div key={floor.id} className="space-y-3">
                        <div className="flex items-center gap-2 border-b pb-2 border-gray-200">
                            <h3 className="text-lg font-bold text-gray-700">{floor.name}</h3>
                            <Badge color="gray">{floor.code}</Badge>
                        </div>
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                            {floor.rooms.map(room => {
                                const itemsInRoom = data.items.filter(i => i.locationId === room.id);
                                return (
                                    <Card key={room.id} className="p-4 hover:shadow-md transition-shadow relative overflow-hidden group">
                                        <div className="flex justify-between items-start mb-2">
                                            <div><h4 className="font-bold text-gray-800">{room.name}</h4><p className="text-xs font-mono text-gray-500 mt-0.5">{room.id}</p></div>
                                            <Badge color={getStatusColor(room.status)}>{room.status}</Badge>
                                        </div>
                                        {hasAdminAccess && (
                                            <div className="flex gap-1 mt-2 mb-4">
                                                {['Vacant', 'Occupied', 'Maintenance'].map(s => (
                                                    <button key={s} onClick={() => changeRoomStatus(room.id, s)} className={`h-1.5 flex-1 rounded-full transition-colors ${room.status === s ? `bg-${getStatusColor(s)}-500` : 'bg-gray-100 hover:bg-gray-200'}`} title={`Set to ${s}`}/>
                                                ))}
                                            </div>
                                        )}
                                        <div className="pt-3 border-t border-gray-100">
                                            <div className="flex justify-between items-center mb-2"><p className="text-xs font-medium text-gray-500">Content ({itemsInRoom.length})</p></div>
                                            <div className="flex gap-2">
                                                <Button size="sm" variant="secondary" className="flex-1 text-xs" onClick={() => setManagingContent({ id: room.id, name: room.name, type: 'room', initialMode: 'view' })}><Settings size={12} /> Manage</Button>
                                                <Button size="sm" variant="secondary" className="flex-1 text-xs" onClick={() => setManagingContent({ id: room.id, name: room.name, type: 'room', initialMode: 'swap' })} title="Quick Swap"><ArrowRightLeft size={12} /> Swap</Button>
                                            </div>
                                        </div>
                                    </Card>
                                );
                            })}
                        </div>
                    </div>
                ))}
            </div>
            );
        };

        const BoxesView = ({ data, setManagingContent }) => {
            return (
            <div className="space-y-6">
                <h2 className="text-2xl font-bold text-gray-800">Storage Boxes</h2>
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                {data.boxes.map(box => {
                    const itemsInBox = data.items.filter(i => i.locationId === box.id);
                    return (
                    <Card key={box.id} className="p-0 overflow-hidden flex flex-col h-full">
                        <div className="bg-gradient-to-r from-orange-50 to-white p-4 border-b border-orange-100 flex justify-between items-center">
                        <div className="flex items-center gap-3"><div className="bg-orange-100 p-2 rounded-lg text-orange-600"><Box size={20} /></div><div><h3 className="font-bold text-gray-800">{box.name}</h3><p className="text-xs text-orange-600 font-mono">ID: {box.id}</p></div></div>
                        <Badge color="orange">{box.type}</Badge>
                        </div>
                        <div className="p-4 flex-1 flex flex-col justify-end">
                        <div className="mb-4 text-center"><p className="text-3xl font-bold text-gray-800">{itemsInBox.length}</p><p className="text-xs text-gray-500 uppercase">Items Stored</p></div>
                        <Button className="w-full" variant="secondary" onClick={() => setManagingContent({ id: box.id, name: box.name, type: 'box' })}>Manage Box Content</Button>
                        </div>
                    </Card>
                    );
                })}
                </div>
            </div>
            );
        };

        const ActivityLogView = ({ data }) => {
            const [selectedLog, setSelectedLog] = useState(null);

            return (
                <div className="space-y-6">
                    <h2 className="text-2xl font-bold text-gray-800">Activity Log</h2>
                    <Card className="overflow-hidden">
                        <div className="overflow-x-auto">
                            <table className="w-full text-left text-sm">
                                <thead className="bg-gray-50 border-b border-gray-200">
                                    <tr>
                                        <th className="px-6 py-3 font-semibold text-gray-700">Timestamp</th>
                                        <th className="px-6 py-3 font-semibold text-gray-700">User</th>
                                        <th className="px-6 py-3 font-semibold text-gray-700">Action</th>
                                        <th className="px-6 py-3 font-semibold text-gray-700">Details</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-gray-200">
                                    {data.logs.map(log => {
                                        // Detect if it has detailed item list by checking for the pattern ": ["
                                        const hasDetails = log.details.includes(': [');
                                        const summary = hasDetails ? log.details.split(':')[0] : log.details;

                                        return (
                                            <tr key={log.id} className="hover:bg-gray-50">
                                                <td className="px-6 py-3 whitespace-nowrap text-gray-500">{new Date(log.timestamp).toLocaleString('en-US', { timeZone: 'Asia/Manila' })}</td>
                                                <td className="px-6 py-3 font-medium text-gray-900">{log.user}</td>
                                                <td className="px-6 py-3"><span className="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">{log.action}</span></td>
                                                <td className="px-6 py-3 text-gray-600">
                                                    <div className="flex items-center justify-between gap-4">
                                                        <span className="truncate max-w-md" title={summary}>{summary}</span>
                                                        {hasDetails && (
                                                            <button 
                                                                onClick={() => setSelectedLog(log)}
                                                                className="text-xs bg-indigo-50 text-indigo-600 px-3 py-1.5 rounded-full border border-indigo-100 hover:bg-indigo-100 hover:shadow-sm transition-all whitespace-nowrap flex items-center gap-1 font-bold shrink-0"
                                                            >
                                                                <Info size={12} /> View Details
                                                            </button>
                                                        )}
                                                    </div>
                                                </td>
                                            </tr>
                                        );
                                    })}
                                </tbody>
                            </table>
                        </div>
                    </Card>
                    <LogDetailsModal log={selectedLog} onClose={() => setSelectedLog(null)} allItems={data.items} />
                </div>
            );
        };

        const SettingsView = ({ data, setData, dialogs, logAction, hasAdminAccess }) => {
            const [settingsTab, setSettingsTab] = useState('storage');
            const [editingCat, setEditingCat] = useState(null);
            const [tempEditValue, setTempEditValue] = useState('');
            const [editingSub, setEditingSub] = useState(null);
            const [tempSubValue, setTempSubValue] = useState('');
            const [creatingProduct, setCreatingProduct] = useState(null); 
            const [newProductName, setNewProductName] = useState('');
            const [editingUser, setEditingUser] = useState(null);
            const [showUserModal, setShowUserModal] = useState(false);

            if (!hasAdminAccess) return <div className="text-center p-10"><Shield size={40} className="mx-auto mb-2 text-gray-300"/><p>Access Denied</p></div>;

            const handleSaveUser = (userData) => {
                if(editingUser) {
                    setData(prev => ({...prev, users: prev.users.map(u => u.id === editingUser.id ? { ...userData, id: u.id } : u)}));
                    logAction('User Management', `Updated user: ${userData.username}`);
                } else {
                    const newUser = { ...userData, id: generateNextId(data.users, 'u') };
                    setData(prev => ({...prev, users: [...prev.users, newUser]}));
                    logAction('User Management', `Created user: ${userData.username}`);
                }
                setShowUserModal(false);
                setEditingUser(null);
            };

            const handleDeleteUser = (userId) => {
                dialogs.showConfirm("Delete this user account?", () => {
                    setData(prev => ({...prev, users: prev.users.filter(u => u.id !== userId)}));
                    logAction('User Management', `Deleted user ${userId}`);
                });
            };

            const handleAddCategory = () => {
                dialogs.showPrompt("New Category Name:", "", (name) => {
                    if(name) {
                        const newCat = { id: generateNextId(data.categories, 'c'), name, subs: [] };
                        setData(prev => ({ ...prev, categories: [...prev.categories, newCat] }));
                        logAction('System', `Created category: ${name}`);
                    }
                });
            };

            const handleAddSubCategory = (catId) => {
                dialogs.showPrompt("New Sub-Category Name:", "", (name) => {
                    if(name) {
                        setData(prev => ({...prev, categories: prev.categories.map(c => c.id === catId ? { ...c, subs: [...c.subs, name] } : c)}));
                        logAction('System', `Created sub-category: ${name}`);
                    }
                });
            };

            const handleRenameCat = (catId, newName) => {
                if (!newName) return;
                setData(prev => ({
                    ...prev,
                    categories: prev.categories.map(c => c.id === catId ? { ...c, name: newName } : c),
                    items: prev.items.map(i => {
                        const oldCat = data.categories.find(c => c.id === catId);
                        if (i.category === oldCat?.name) return { ...i, category: newName };
                        return i;
                    })
                }));
                setEditingCat(null);
            };

            const handleDeleteCat = (catId, catName) => {
                dialogs.showConfirm(`CRITICAL: Delete Category "${catName}"? This will delete ALL sub-categories and items within it.`, () => {
                    setData(prev => ({...prev, categories: prev.categories.filter(c => c.id !== catId), items: prev.items.filter(i => i.category !== catName)}));
                });
            };

            const handleCreateProduct = (cat, sub) => {
                if(!newProductName) return;
                dialogs.showConfirm(`Create new product card "${newProductName}" under ${sub}?`, () => {
                    const newId = generateId(newProductName, data.items);
                    const newItem = { id: newId, name: newProductName, category: cat, subCategory: sub, location: 'Unassigned', locationId: '', type: 'none', status: 'Active', condition: 'Working' };
                    setData(prev => ({...prev, items: [...prev.items, newItem]}));
                    logAction('System', `Created new product type: ${newProductName}`);
                    setNewProductName('');
                    setCreatingProduct(null);
                });
            };

            const handleRenameSub = (catName, oldSub, newSub) => {
                if (!newSub) return;
                setData(prev => ({
                    ...prev,
                    categories: prev.categories.map(c => c.name === catName ? { ...c, subs: c.subs.map(s => s === oldSub ? newSub : s) } : c),
                    items: prev.items.map(i => i.subCategory === oldSub && i.category === catName ? { ...i, subCategory: newSub } : i)
                }));
                setEditingSub(null);
            };

            const handleDeleteSub = (catName, sub) => {
                dialogs.showConfirm(`CRITICAL: Delete sub-category "${sub}"? This will permanently delete ALL associated items!`, () => {
                    setData(prev => ({
                        ...prev,
                        categories: prev.categories.map(c => c.name === catName ? { ...c, subs: c.subs.filter(s => s !== sub) } : c),
                        items: prev.items.filter(i => !(i.category === catName && i.subCategory === sub))
                    }));
                });
            };

            const uniqueProducts = useMemo(() => {
                const products = [];
                data.items.forEach(i => { if (!products.some(p => p.name === i.name && p.cat === i.category && p.sub === i.subCategory)) products.push({ name: i.name, cat: i.category, sub: i.subCategory }); });
                return products;
            }, [data.items]);

            const handleRenameProduct = (oldName, newName, cat, sub) => {
                if(!newName) return;
                dialogs.showConfirm(`Rename product "${oldName}" to "${newName}" for all items?`, () => {
                    setData(prev => ({...prev, items: prev.items.map(i => (i.name === oldName && i.category === cat && i.subCategory === sub) ? { ...i, name: newName } : i)}));
                });
            };

            const handleDeleteProduct = (name, cat, sub) => {
                dialogs.showConfirm(`CRITICAL: Delete ALL instances of "${name}"? This cannot be undone.`, () => {
                    setData(prev => ({...prev, items: prev.items.filter(i => !(i.name === name && i.category === cat && i.subCategory === sub))}));
                });
            };

            const handleRenameFloor = (floorId, newName) => {
                if(!newName) return;
                setData(prev => ({...prev, floors: prev.floors.map(f => f.id === floorId ? { ...f, name: newName } : f)}));
            };

            const handleDeleteFloor = (floorId) => {
                dialogs.showConfirm('Delete this Floor? All rooms and assignments will be removed.', () => {
                    setData(prev => ({...prev, floors: prev.floors.filter(f => f.id !== floorId), items: prev.items.map(i => { return i; }) }));
                });
            }

            const handleRenameRoom = (floorId, roomId, newName) => {
                if(!newName) return;
                setData(prev => ({...prev, floors: prev.floors.map(f => f.id === floorId ? { ...f, rooms: f.rooms.map(r => r.id === roomId ? { ...r, name: newName } : r) } : f)}));
            };

            const handleDeleteRoom = (floorId, roomId) => {
                dialogs.showConfirm('Delete this room?', () => {
                    setData(prev => ({
                        ...prev,
                        floors: prev.floors.map(f => f.id === floorId ? { ...f, rooms: f.rooms.filter(r => r.id !== roomId) } : f),
                        items: prev.items.map(i => i.locationId === roomId ? { ...i, location: 'Unassigned', locationId: '', type: 'none' } : i)
                    }));
                });
            };

            const handleAddBox = () => {
                dialogs.showPrompt("New Box Name (e.g. Box-C01):", "", (name) => {
                    if(name) {
                        dialogs.showPrompt("Box Type (e.g. Plastic Bin):", "Generic", (type) => {
                            const newId = generateNextId(data.boxes, 'b');
                            const newBox = { id: newId, name, type: type || "Generic" };
                            setData(prev => ({ ...prev, boxes: [...prev.boxes, newBox] }));
                        });
                    }
                });
            };

            const handleRenameBox = (boxId, newName) => {
                if(!newName) return;
                setData(prev => ({...prev, boxes: prev.boxes.map(b => b.id === boxId ? { ...b, name: newName } : b)}));
            };

            const handleDeleteBox = (boxId) => {
                dialogs.showConfirm("Delete this box? Items inside will be unassigned.", () => {
                    setData(prev => ({
                        ...prev,
                        boxes: prev.boxes.filter(b => b.id !== boxId),
                        items: prev.items.map(i => i.locationId === boxId ? { ...i, location: 'Unassigned', locationId: '', type: 'none' } : i)
                    }));
                });
            };

            const handleBackup = () => {
                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(data));
                const downloadAnchorNode = document.createElement('a');
                downloadAnchorNode.setAttribute("href", dataStr);
                downloadAnchorNode.setAttribute("download", "IMS_Backup_" + new Date().toISOString().split('T')[0] + ".json");
                document.body.appendChild(downloadAnchorNode);
                downloadAnchorNode.click();
                downloadAnchorNode.remove();
                logAction('System', 'Data backup created');
            };

            const handleRestore = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const restoredData = JSON.parse(e.target.result);
                        if (!restoredData.items || !restoredData.users || !restoredData.floors) {
                            dialogs.showAlert("Invalid backup file format.");
                            return;
                        }
                        dialogs.showConfirm("WARNING: Restoring data will overwrite ALL current inventory and settings. Continue?", () => {
                            setData(restoredData);
                            logAction('System', 'Data restored from backup');
                            dialogs.showAlert("System restored successfully.");
                        });
                    } catch (error) {
                        dialogs.showAlert("Error parsing backup file.");
                    }
                };
                reader.readAsText(file);
                // Reset input
                event.target.value = ''; 
            };

            const handleReset = () => {
                dialogs.showPrompt("To confirm FACTORY RESET, type 'RESET':", "", (val) => {
                    if (val === 'RESET') {
                        setData(INITIAL_DATA);
                        logAction('System', 'System factory reset');
                        dialogs.showAlert("System reset to initial state.");
                    } else if (val) {
                        dialogs.showAlert("Reset cancelled. Incorrect confirmation.");
                    }
                });
            };

            return (
              <div className="space-y-6">
                <div className="border-b border-gray-200"><nav className="-mb-px flex space-x-8 overflow-x-auto">{['Storage', 'Floor', 'Boxes', 'Accounts', 'Report', 'Backup'].map((tab) => (<button key={tab} onClick={() => setSettingsTab(tab.toLowerCase())} className={`py-4 px-1 border-b-2 font-medium text-sm whitespace-nowrap ${settingsTab === tab.toLowerCase() ? 'border-indigo-500 text-indigo-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'}`}>{tab}</button>))}</nav></div>
                <div className="mt-6">
                  {settingsTab === 'storage' && (<div className="space-y-6"><Button variant="ghost" onClick={handleAddCategory} className="w-full py-4 border-dashed border-2 bg-white hover:bg-white text-gray-600 hover:text-indigo-600"><Plus className="mr-2"/> Add New Category</Button>{data.categories.map((cat, idx) => (<Card key={cat.id} className="p-0 overflow-hidden"><div className="bg-gray-50 p-4 border-b border-gray-200 flex justify-between items-center">{editingCat === cat.id ? (<div className="flex gap-2"><input value={tempEditValue} onChange={e => setTempEditValue(e.target.value)} className="border rounded px-2 py-1" autoFocus /><Button size="sm" onClick={() => handleRenameCat(cat.id, tempEditValue)}><Save size={14} className="mr-1"/> Save</Button><Button size="sm" variant="secondary" onClick={() => setEditingCat(null)}>Cancel</Button></div>) : (<div className="flex items-center gap-3"><span className="font-bold text-lg">{cat.name}</span><div className="flex gap-1"><button onClick={() => { setEditingCat(cat.id); setTempEditValue(cat.name); }} className="text-gray-400 hover:text-indigo-600 p-1"><Edit size={16}/></button><button onClick={() => handleDeleteCat(cat.id, cat.name)} className="text-gray-400 hover:text-red-600 p-1"><Trash2 size={16}/></button></div></div>)}<div className="flex gap-2 text-xs"><span className="bg-white px-2 py-1 rounded border">{cat.subs.length} Sub-cats</span></div></div><div className="p-4 space-y-4">{cat.subs.map((sub, sIdx) => (<div key={`${sub}-${sIdx}`} className="border p-4 rounded-lg bg-white shadow-sm"><div className="flex justify-between items-center mb-4 border-b pb-3">{editingSub?.cat === cat.name && editingSub?.sub === sub ? (<div className="flex gap-2"><input value={tempSubValue} onChange={e => setTempSubValue(e.target.value)} className="border rounded px-2 py-1 text-xs" autoFocus /><Button size="sm" onClick={() => handleRenameSub(cat.name, sub, tempSubValue)}><Save size={14} className="mr-1"/> Save</Button><Button size="sm" variant="secondary" onClick={() => setEditingSub(null)}>Cancel</Button></div>) : (<div className="flex items-center gap-2"><span className="font-bold text-gray-700 text-lg">{sub}</span><button onClick={() => { setEditingSub({cat: cat.name, sub}); setTempSubValue(sub); }} className="text-gray-400 hover:text-indigo-600"><Edit size={14}/></button><button onClick={() => handleDeleteSub(cat.name, sub)} className="text-gray-400 hover:text-red-600"><Trash2 size={14}/></button></div>)}<Button size="sm" variant="secondary" onClick={() => setCreatingProduct({cat: cat.name, sub})}><Plus size={14} /> <span className="hidden md:inline">Create Product Card</span></Button></div>{creatingProduct?.cat === cat.name && creatingProduct?.sub === sub && (<div className="bg-blue-50 p-3 rounded mb-4 flex gap-2 items-center animate-in fade-in"><span className="text-xs font-bold text-blue-700 whitespace-nowrap">New Item Name:</span><input className="flex-1 border border-blue-200 rounded px-2 py-1 text-sm focus:outline-none focus:border-blue-500" placeholder="e.g. LED Panel 500W" autoFocus value={newProductName} onChange={e => setNewProductName(e.target.value)} onKeyDown={e => e.key === 'Enter' && handleCreateProduct(cat.name, sub)} /><Button size="sm" onClick={() => handleCreateProduct(cat.name, sub)}>Create</Button><Button size="sm" variant="ghost" onClick={() => {setCreatingProduct(null); setNewProductName('');}}><X size={14}/></Button></div>)}<div className="space-y-2"><p className="text-[10px] font-bold text-gray-400 uppercase tracking-wide">Registered Items:</p><div className="grid grid-cols-1 md:grid-cols-2 gap-2">{uniqueProducts.filter(p => p.cat === cat.name && p.sub === sub).map((prod, pIdx) => (<div key={pIdx} className="flex justify-between items-center text-sm p-3 bg-gray-50 rounded border border-gray-100 hover:border-gray-300 transition-colors"><span className="font-medium text-gray-700">{prod.name}</span><div className="flex items-center gap-2"><span className="text-xs text-gray-500 bg-white px-2 py-0.5 rounded border">Qty: {data.items.filter(i => i.name === prod.name).length}</span><button title="Rename Product" onClick={() => { dialogs.showPrompt("Rename Product Type:", prod.name, (newName) => { handleRenameProduct(prod.name, newName, cat.name, sub); }); }} className="text-gray-400 hover:text-blue-600 p-1 hover:bg-blue-50 rounded"><Edit size={14}/></button><button title="Delete Product" onClick={() => handleDeleteProduct(prod.name, cat.name, sub)} className="text-gray-400 hover:text-red-600 p-1 hover:bg-red-50 rounded"><Trash2 size={14}/></button></div></div>))}</div>{uniqueProducts.filter(p => p.cat === cat.name && p.sub === sub).length === 0 && (<p className="text-xs text-gray-400 italic p-2 border border-dashed rounded text-center">No products registered yet.</p>)}</div></div>))}<Button size="sm" variant="ghost" className="w-full border border-dashed bg-white hover:bg-white" onClick={() => handleAddSubCategory(cat.id)}><Plus size={14} className="mr-1"/> Add Sub-Category</Button></div></Card>))}</div>)}

                  {settingsTab === 'floor' && (<div className="space-y-6">{data.floors.map((floor) => (<Card key={floor.id} className="p-0"><div className="bg-gray-50 p-4 border-b border-gray-200 flex justify-between items-center"><div className="flex items-center gap-2"><span className="font-bold">{floor.name}</span><button className="text-gray-400 hover:text-indigo-600" onClick={() => { dialogs.showPrompt("Rename Floor:", floor.name, (newName) => { handleRenameFloor(floor.id, newName); }); }}><Edit size={14}/></button><Badge>{floor.code}</Badge></div><div className="flex gap-2"><Button size="sm" variant="secondary" onClick={() => { dialogs.showPrompt("New Room Name:", "", (name) => { if(name) { const nextRoomId = generateRoomId(floor.code, data.floors.flatMap(f => f.rooms)); const newRoom = { id: nextRoomId, name, status: 'Vacant' }; setData(prev => ({...prev, floors: prev.floors.map(f => f.id === floor.id ? { ...f, rooms: [...f.rooms, newRoom] } : f)})); } }); }}>Add Room</Button><button className="text-red-400 p-2 hover:bg-red-50 rounded" onClick={() => handleDeleteFloor(floor.id)}><Trash2 size={16}/></button></div></div><div className="p-4 space-y-2">{floor.rooms.map((room) => (<div key={room.id} className="flex items-center justify-between p-3 border rounded hover:bg-gray-50"><div className="flex items-center gap-3"><span className="font-mono text-xs bg-gray-200 px-1 rounded text-gray-600">{room.id}</span><span className="font-medium">{room.name}</span><button className="text-gray-300 hover:text-indigo-600" onClick={() => { dialogs.showPrompt("Rename Room:", room.name, (newName) => { handleRenameRoom(floor.id, room.id, newName); }); }}><Edit size={12}/></button></div><div className="flex items-center gap-2"><button className="text-red-400 hover:text-red-600 ml-2" onClick={() => handleDeleteRoom(floor.id, room.id)}><Trash2 size={14}/></button></div></div>))}</div></Card>))}<Button variant="ghost" className="w-full py-4 border-dashed border-2 bg-white hover:bg-white text-gray-600 hover:text-indigo-600" onClick={() => { dialogs.showPrompt("New Floor Name (e.g. 3rd Floor):", "", (name) => { if(name) { dialogs.showPrompt("Floor Code (e.g. F3):", "", (code) => { if(code) { const newId = generateNextId(data.floors, 'f'); const newFloor = { id: newId, name, code, rooms: [] }; setData(prev => ({ ...prev, floors: [...prev.floors, newFloor] })); } }); } }); }}>+ Add New Floor</Button></div>)}
                  
                  {settingsTab === 'boxes' && (<div className="space-y-6"><div className="flex justify-between items-center"><h3 className="font-bold text-lg">Manage Storage Boxes</h3><Button onClick={handleAddBox}><Plus size={16}/> Add New Box</Button></div><div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">{data.boxes.map(box => (<div key={box.id} className="bg-white p-4 border rounded shadow-sm flex flex-col justify-between"><div><div className="flex justify-between items-start mb-2"><Box className="text-orange-500" /><div className="flex gap-2"><button onClick={() => { dialogs.showPrompt("Rename Box:", box.name, (newName) => { handleRenameBox(box.id, newName); }); }} className="text-gray-400 hover:text-indigo-600"><Edit size={16}/></button><button onClick={() => handleDeleteBox(box.id)} className="text-gray-400 hover:text-red-600"><Trash2 size={16}/></button></div></div><h4 className="font-bold text-gray-800">{box.name}</h4><p className="text-xs text-orange-600 font-mono">ID: {box.id}</p></div><div className="mt-4 pt-2 border-t text-xs text-gray-400">ID: {box.id}</div></div>))}</div></div>)}

                  {settingsTab === 'accounts' && (<div className="space-y-8"><div className="flex justify-between items-center"><h3 className="font-bold text-lg">User Accounts</h3><Button onClick={() => { setEditingUser(null); setShowUserModal(true); }}><Plus size={16}/> Add New User</Button></div>{[ROLES.SUPERVISOR, ROLES.LEAD, ROLES.TRAINER, ROLES.OPERATOR].map((role) => { const usersInRole = data.users.filter(u => u.role === role); if (usersInRole.length === 0) return null; return (<div key={role} className="space-y-3 animate-in fade-in"><h4 className="font-bold text-gray-500 text-xs uppercase tracking-wider border-b border-gray-200 pb-1 mb-2">{role}s</h4><div className="grid grid-cols-1 md:grid-cols-2 gap-4">{usersInRole.map(u => (<UserCard key={u.id} user={u} onEdit={() => { setEditingUser(u); setShowUserModal(true); }} onDelete={handleDeleteUser}/>))}</div></div>); })}{showUserModal && (<UserModal userToEdit={editingUser} onSave={handleSaveUser} onClose={() => setShowUserModal(false)} dialogs={dialogs}/>)}</div>)}

                  {settingsTab === 'report' && (<Card><ReportGenerator data={data} dialogs={dialogs} /></Card>)}

                  {settingsTab === 'backup' && (
                        <div className="space-y-6">
                            <Card className="p-6">
                                <h3 className="text-lg font-bold mb-4 flex items-center gap-2"><Save size={20} /> Backup & Restore</h3>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div className="p-4 border rounded bg-gray-50">
                                        <h4 className="font-bold text-gray-700 mb-2">Export Data</h4>
                                        <p className="text-xs text-gray-500 mb-4">Download a local copy of the entire database.</p>
                                        <Button onClick={handleBackup} className="w-full"><Download size={16} /> Download Backup</Button>
                                    </div>
                                    <div className="p-4 border rounded bg-gray-50">
                                        <h4 className="font-bold text-gray-700 mb-2">Import Data</h4>
                                        <p className="text-xs text-gray-500 mb-4">Restore from a previously saved JSON file.</p>
                                        <div className="relative">
                                            <input type="file" accept=".json" onChange={handleRestore} className="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-20" />
                                            <Button variant="secondary" className="w-full"><ArrowUpDown size={16} /> Select Backup File</Button>
                                        </div>
                                    </div>
                                </div>
                            </Card>

                            <Card className="p-6 border-red-200 bg-red-50">
                                <h3 className="text-lg font-bold mb-2 text-red-800 flex items-center gap-2"><AlertTriangle size={20} /> Danger Zone</h3>
                                <div className="flex flex-col md:flex-row justify-between items-center gap-4">
                                    <div>
                                        <h4 className="font-bold text-red-900">Factory Reset</h4>
                                        <p className="text-xs text-red-700">Permanently delete all data and reset to default. This cannot be undone.</p>
                                    </div>
                                    <Button onClick={handleReset} variant="danger" className="whitespace-nowrap"><Trash2 size={16} /> Reset System</Button>
                                </div>
                            </Card>
                        </div>
                    )}
                </div>
              </div>
            );
        };

        // --- Main App Component ---

        const InventoryApp = () => {
          const [user, setUser] = useState(() => {
              const savedUser = localStorage.getItem('ims_user_v1');
              return savedUser ? JSON.parse(savedUser) : null;
          });
          
          const [activeTab, setActiveTab] = useState('dashboard');
          const [showProfileModal, setShowProfileModal] = useState(false);
          const [mobileMenuOpen, setMobileMenuOpen] = useState(false); // Mobile Menu State
          const [data, setData] = useState(INITIAL_DATA);
          const [isLoading, setIsLoading] = useState(true);
          const [managingContent, setManagingContent] = useState(null); 
          const isRemoteUpdate = useRef(false);
          
          // Toast state for double back press
          const [showExitToast, setShowExitToast] = useState(false);
          
          const [dialogState, setDialogState] = useState({ isOpen: false, type: 'alert', message: '', defaultValue: '', onConfirm: () => {} });

          // --- Back Button Handling Refs & Logic ---
          const stateRef = useRef({
              managingContent: null,
              showProfileModal: false,
              mobileMenuOpen: false,
              dialogOpen: false
          });

          // Sync refs with state for the event listener
          useEffect(() => {
              stateRef.current = {
                  managingContent,
                  showProfileModal,
                  mobileMenuOpen,
                  dialogOpen: dialogState.isOpen
              };
          }, [managingContent, showProfileModal, mobileMenuOpen, dialogState.isOpen]);

          const lastBackPress = useRef(0);

          useEffect(() => {
              // Push initial state to allow intercepting the back button
              window.history.pushState(null, document.title, window.location.href);

              const handlePopState = (event) => {
                  const { managingContent, showProfileModal, mobileMenuOpen, dialogOpen } = stateRef.current;

                  // 1. Close Custom Dialogs first
                  if (dialogOpen) {
                      setDialogState(prev => ({ ...prev, isOpen: false }));
                      window.history.pushState(null, document.title, window.location.href);
                      return;
                  }

                  // 2. Close Modals (Content Manager or Profile)
                  if (managingContent || showProfileModal) {
                      if (managingContent) setManagingContent(null);
                      if (showProfileModal) setShowProfileModal(false);
                      window.history.pushState(null, document.title, window.location.href);
                      return;
                  }

                  // 3. Close Mobile Menu
                  if (mobileMenuOpen) {
                      setMobileMenuOpen(false);
                      window.history.pushState(null, document.title, window.location.href);
                      return;
                  }

                  // 4. Double Back to Exit Logic
                  const now = Date.now();
                  if (now - lastBackPress.current < 2000) {
                      // Allow exit (do not push state back)
                      // This effectively lets the browser go back in history or close the PWA
                  } else {
                      lastBackPress.current = now;
                      setShowExitToast(true);
                      setTimeout(() => setShowExitToast(false), 2000);
                      // Trap user again
                      window.history.pushState(null, document.title, window.location.href);
                  }
              };

              window.addEventListener('popstate', handlePopState);

              // Force portrait lock on mount (if supported)
              if (screen.orientation && screen.orientation.lock) {
                  screen.orientation.lock("portrait").catch((error) => {
                      // Silently fail if lock is not allowed
                  });
              }

              return () => {
                  window.removeEventListener('popstate', handlePopState);
              };
          }, []);

          // --- Firebase Sync Logic ---
          
          // 1. Initial Load & Real-time Listener
          useEffect(() => {
              const docRef = db.collection('inventory').doc('main_data');
              
              const unsubscribe = docRef.onSnapshot((docSnapshot) => {
                  if (docSnapshot.exists) {
                      const remoteData = docSnapshot.data();
                      // Mark that this update is coming from DB so we don't save it back immediately
                      isRemoteUpdate.current = true;
                      setData(remoteData);
                      setIsLoading(false);
                  } else {
                      // Doc doesn't exist, create it with initial data
                      docRef.set(INITIAL_DATA).then(() => {
                          setData(INITIAL_DATA);
                          setIsLoading(false);
                      });
                  }
              }, (error) => {
                  console.error("Error fetching data:", error);
                  // Fallback to local if error (e.g., offline cache empty)
                  setIsLoading(false);
              });

              return () => unsubscribe();
          }, []);

          // 2. Save on Change
          useEffect(() => {
              // If this change came from Firestore, don't write it back
              if (isRemoteUpdate.current) {
                  isRemoteUpdate.current = false;
                  return;
              }

              // Otherwise, it's a local user action, so save to DB
              if (!isLoading) {
                  // Use a timeout to debounce writes slightly if needed, but direct set is fine for this scale
                  db.collection('inventory').doc('main_data').set(data)
                    .catch(err => console.error("Error saving data:", err));
              }
          }, [data, isLoading]);


          useEffect(() => {
              if (user) localStorage.setItem('ims_user_v1', JSON.stringify(user));
              else localStorage.removeItem('ims_user_v1');
          }, [user]);

          const dialogs = useMemo(() => ({
              showAlert: (msg) => setDialogState({ isOpen: true, type: 'alert', message: msg, onConfirm: () => setDialogState(prev => ({...prev, isOpen: false})) }),
              showConfirm: (msg, onConfirm) => setDialogState({ isOpen: true, type: 'confirm', message: msg, onConfirm: () => { setDialogState(prev => ({...prev, isOpen: false})); setTimeout(onConfirm, 100); } }),
              showPrompt: (msg, defaultValue, onConfirm) => setDialogState({ isOpen: true, type: 'prompt', message: msg, defaultValue, onConfirm: (val) => { setDialogState(prev => ({...prev, isOpen: false})); setTimeout(() => onConfirm(val), 100); } })
          }), []);


          const logAction = (action, details) => {
            const newLog = { id: Date.now(), timestamp: new Date().toISOString(), user: user?.name || 'Unknown', action, details };
            setData(prev => ({ ...prev, logs: [newLog, ...prev.logs] }));
          };

          const hasAdminAccess = useMemo(() => user && ADMIN_ROLES.includes(user.role), [user]);

          const handleProfileUpdate = (updatedUser) => {
            setUser(updatedUser);
            setData(prev => ({ ...prev, users: prev.users.map(u => u.id === updatedUser.id ? updatedUser : u) }));
            logAction('Profile Update', `User ${updatedUser.username} updated their profile`);
          };

          const handleLogin = (loggedInUser) => {
             setUser(loggedInUser);
             const newLog = { id: Date.now(), timestamp: new Date().toISOString(), user: loggedInUser.name, action: 'Login', details: `User ${loggedInUser.username} logged in` };
             setData(prev => ({ ...prev, logs: [newLog, ...prev.logs] }));
          };

          // --- Render Loading Screen ---
          if (isLoading) {
              return (
                  <div className="min-h-screen bg-gradient-to-br from-indigo-900 to-indigo-700 flex items-center justify-center flex-col text-white">
                      <div className="bg-white/10 p-8 rounded-2xl backdrop-blur-sm shadow-2xl flex flex-col items-center animate-in zoom-in duration-500">
                          <div className="bg-white p-4 rounded-full shadow-lg mb-6">
                              <Package className="w-12 h-12 text-indigo-600 animate-pulse" />
                          </div>
                          <h1 className="text-3xl font-black tracking-tight mb-2">IMS</h1>
                          <p className="text-indigo-100 font-medium mb-8 text-sm uppercase tracking-widest opacity-80">Inventory Management System</p>
                          
                          <div className="w-48 bg-indigo-950/30 rounded-full h-1.5 mb-4 overflow-hidden">
                              <div className="bg-white h-full rounded-full w-1/3 animate-[loading_1s_ease-in-out_infinite]" style={{ width: '30%' }}></div>
                          </div>
                          <p className="text-xs text-indigo-200 animate-pulse">Initializing Database...</p>
                      </div>
                      
                      <style>{`
                          @keyframes loading {
                              0% { transform: translateX(-100%); }
                              100% { transform: translateX(300%); }
                          }
                      `}</style>
                  </div>
              );
          }

          if (!user) return <LoginView onLogin={handleLogin} users={data.users} />;

          const NavItem = ({ id, label, icon: Icon }) => (
            <button onClick={() => { setActiveTab(id); setMobileMenuOpen(false); }} className={`w-full flex items-center gap-3 px-4 py-3 text-sm font-medium transition-colors ${activeTab === id ? 'bg-indigo-50 text-indigo-700 border-r-4 border-indigo-600' : 'text-gray-600 hover:bg-gray-50'}`}>
              <Icon className="w-5 h-5" />{label}
            </button>
          );

          return (
            <div className="min-h-screen bg-white font-sans flex text-gray-900 flex-col lg:flex-row">
              
              {/* Mobile Header */}
              <div className="lg:hidden flex items-center justify-between bg-white border-b border-gray-200 p-4 sticky top-0 z-20 print-hidden shadow-sm">
                 <div className="flex items-center gap-3">
                     <img src="./icon-512.png" className="w-8 h-8 rounded-lg" alt="Logo" />
                     <span className="font-bold text-gray-900 text-lg">IMS</span>
                 </div>
                 <button onClick={() => setMobileMenuOpen(!mobileMenuOpen)} className="p-2 text-gray-600 rounded-md hover:bg-gray-100 active:bg-gray-200">
                     <Menu size={24} />
                 </button>
              </div>

              {/* Mobile Menu Overlay */}
              {mobileMenuOpen && (
                  <div 
                      className="fixed inset-0 bg-black/50 z-30 lg:hidden animate-in fade-in duration-200"
                      onClick={() => setMobileMenuOpen(false)}
                  />
              )}

              {/* Sidebar */}
              <aside className={`flex flex-col w-64 bg-white border-r border-gray-200 fixed inset-y-0 left-0 z-40 print-hidden transition-transform duration-300 ease-in-out lg:translate-x-0 ${mobileMenuOpen ? 'translate-x-0 shadow-xl' : '-translate-x-full'}`}>
                <div className="p-6 flex items-center gap-3 border-b border-gray-100">
                    <img src="./icon-512.png" className="w-10 h-10 rounded-lg" alt="Logo" />
                    <div><h1 className="font-bold text-gray-900 leading-tight">IMS</h1><p className="text-[10px] text-gray-400 font-medium">V10.7 ENTERPRISE</p></div>
                </div>
                <nav className="flex-1 py-6 space-y-1 overflow-y-auto">
                  <NavItem id="dashboard" label="Dashboard" icon={LayoutDashboard} />
                  <NavItem id="storage" label="Inventory" icon={Package} />
                  <NavItem id="floors" label="Floors & Rooms" icon={Layers} />
                  <NavItem id="boxes" label="Storage Boxes" icon={Box} />
                  <NavItem id="activity" label="Activity Log" icon={History} />
                  <NavItem id="settings" label="Settings" icon={Settings} />
                </nav>
                <div className="p-4 border-t border-gray-100"><div className="flex items-center gap-3 px-4 py-3 bg-gray-50 rounded-lg mb-2 cursor-pointer hover:bg-gray-100" onClick={() => { setShowProfileModal(true); setMobileMenuOpen(false); }}><div className="bg-indigo-100 p-2 rounded-full"><User className="w-4 h-4 text-indigo-600" /></div><div className="overflow-hidden"><p className="text-sm font-bold text-gray-900 truncate">{user.name}</p><p className="text-xs text-gray-500 truncate" title={user.role}>{user.role}</p></div><Settings size={14} className="text-gray-400" /></div><button onClick={() => setUser(null)} className="w-full flex items-center justify-center gap-2 text-sm text-red-600 hover:bg-red-50 p-2 rounded-lg"><LogOut className="w-4 h-4" /> Sign Out</button></div>
              </aside>

              {/* Main Content */}
              <main className="flex-1 lg:ml-64 p-4 lg:p-8 print:m-0 print:p-0 w-full lg:w-auto">
                <div className="max-w-7xl mx-auto print:hidden">
                  {activeTab === 'dashboard' && <DashboardView data={data} setActiveTab={setActiveTab} />}
                  {activeTab === 'storage' && <StorageView data={data} setData={setData} dialogs={dialogs} logAction={logAction} hasAdminAccess={hasAdminAccess} />}
                  {activeTab === 'floors' && <FloorsView data={data} setData={setData} dialogs={dialogs} logAction={logAction} hasAdminAccess={hasAdminAccess} setManagingContent={setManagingContent} />}
                  {activeTab === 'boxes' && <BoxesView data={data} setManagingContent={setManagingContent} />}
                  {activeTab === 'activity' && <ActivityLogView data={data} />}
                  {activeTab === 'settings' && <SettingsView data={data} setData={setData} dialogs={dialogs} logAction={logAction} hasAdminAccess={hasAdminAccess} />}
                </div>
                
                {managingContent && (
                    managingContent.initialMode === 'swap' && managingContent.type === 'room' ? (
                        <RoomSwapModal 
                            sourceRoom={{
                                id: managingContent.id, 
                                name: managingContent.name, 
                                status: data.floors.flatMap(f => f.rooms).find(r => r.id === managingContent.id)?.status || 'Unknown'
                            }}
                            data={data}
                            setData={setData}
                            logAction={logAction}
                            dialogs={dialogs}
                            onClose={() => setManagingContent(null)}
                        />
                    ) : (
                        <ContentManager 
                            targetId={managingContent.id} 
                            targetName={managingContent.name} 
                            type={managingContent.type} 
                            data={data}
                            setData={setData}
                            dialogs={dialogs}
                            logAction={logAction}
                            initialMode={managingContent.initialMode}
                            onClose={() => setManagingContent(null)} 
                        />
                    )
                )}
                
                {showProfileModal && <ProfileModal user={user} onUpdate={handleProfileUpdate} logAction={logAction} dialogs={dialogs} onClose={() => setShowProfileModal(false)} />}
                
                <CustomDialog 
                    isOpen={dialogState.isOpen}
                    type={dialogState.type}
                    message={dialogState.message}
                    defaultValue={dialogState.defaultValue}
                    onConfirm={dialogState.onConfirm}
                    onClose={() => setDialogState(prev => ({ ...prev, isOpen: false }))}
                />

                {/* Exit Toast Notification */}
                {showExitToast && (
                    <div className="fixed bottom-8 left-1/2 -translate-x-1/2 bg-gray-800 text-white px-4 py-2 rounded-full shadow-lg text-sm z-50 animate-in fade-in slide-in-from-bottom-2">
                        Press back again to exit
                    </div>
                )}
              </main>
            </div>
          );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<InventoryApp />);
    </script>
</body>
</html>